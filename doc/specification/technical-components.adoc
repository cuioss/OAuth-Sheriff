= JWT Token Handling Technical Components
:toc:
:toclevels: 3
:toc-title: Table of Contents
:sectnums:

link:../Specification.adoc[Back to Main Specification]

== Overview
_See Requirement link:../Requirements.adoc#CUI-JWT-1[CUI-JWT-1: Token Parsing and Validation]_

This document provides detailed specifications for the technical components of the JWT token handling library.

== Component Specifications

=== TokenFactory
_See Requirement link:../Requirements.adoc#CUI-JWT-2[CUI-JWT-2: Token Representation]_

==== Status: IMPLEMENTED

This specification has been implemented in the following classes:

* link:../src/main/java/de/cuioss/jwt/token/TokenFactory.java[TokenFactory] (interface)
* link:../src/main/java/de/cuioss/jwt/token/TokenFactoryImpl.java[TokenFactoryImpl] (implementation)

The `TokenFactory` is the primary entry point for applications using the library. It provides methods for creating and validating different types of tokens (access, ID, refresh) while handling the complexity of token parsing and validation.

==== Interface Definition

The TokenFactory interface defines the following methods:

* `Optional<ParsedToken> createToken(String tokenString)` - Creates a generic token from a token string
* `Optional<ParsedAccessToken> createAccessToken(String tokenString)` - Creates an access token from a token string
* `Optional<ParsedIdToken> createIdToken(String tokenString)` - Creates an ID token from a token string
* `Optional<ParsedRefreshToken> createRefreshToken(String tokenString)` - Creates a refresh token from a token string

The implementation uses the `MultiIssuerTokenParser` to parse and validate tokens, creates the appropriate token type based on the token content, and handles exceptions by returning empty optionals for invalid tokens.

Refer to the implementation and associated JavaDoc for detailed behavior.

=== JwtParser
_See Requirement link:../Requirements.adoc#CUI-JWT-1.3[CUI-JWT-1.3: Signature Validation]_

==== Status: IMPLEMENTED

This specification has been implemented in the following classes:

* link:../src/main/java/de/cuioss/jwt/token/JwtParser.java[JwtParser] (interface)
* link:../src/main/java/de/cuioss/jwt/token/JwksAwareTokenParserImpl.java[JwksAwareTokenParserImpl] (implementation)

The `JwtParser` interface defines the contract for JWT token parsing and validation. It provides an abstract configuration structure for token parsing and validation.

==== Interface Definition

The JwtParser interface defines the following methods:

* `Optional<Jws<Claims>> parseToken(String token) throws JwtException` - Parses and validates a JWT token
* `boolean supportsIssuer(String issuer)` - Checks if this parser supports a specific issuer
* `String getIssuer()` - Returns the issuer supported by this parser

The implementation parses the token using the JJWT library, validates the token signature using keys from the `JwksLoader`, validates required claims (issuer, expiration time, not before time), and returns the parsed token as a `Jws<Claims>` object.

Note: Audience (aud) claim validation is currently not implemented (see TODO.adoc).

Refer to the implementation and associated JavaDoc for detailed behavior.

=== MultiIssuerJwtParser
_See Requirement link:../Requirements.adoc#CUI-JWT-3[CUI-JWT-3: Multi-Issuer Support]_

==== Status: IMPLEMENTED

This specification has been implemented in the following classes:

* link:../src/main/java/de/cuioss/jwt/token/util/MultiIssuerJwtParser.java[MultiIssuerJwtParser]

The `MultiIssuerJwtParser` manages multiple JWT token parsers for different token issuers in a multi-tenant environment. It inspects JWT tokens, determines their issuer, and selects the appropriate parser.

==== Implementation Details

The implementation extracts the issuer claim from the token without validating the signature, selects the appropriate parser based on the issuer, and delegates token parsing and validation to the selected parser.

The class provides methods for adding parsers for different issuers and configuring a default parser for tokens with unknown issuers.

Refer to the implementation and associated JavaDoc for detailed behavior.

=== JwksLoader
_See Requirement link:../Requirements.adoc#CUI-JWT-4[CUI-JWT-4: Key Management]_

==== Status: IMPLEMENTED

This specification has been implemented in the following classes:

* link:../src/main/java/de/cuioss/jwt/token/jwks/JwksLoader.java[JwksLoader] (interface)
* link:../src/main/java/de/cuioss/jwt/token/jwks/HttpJwksLoader.java[HttpJwksLoader] (implementation)
* link:../src/main/java/de/cuioss/jwt/token/jwks/JWKSKeyLoader.java[JWKSKeyLoader] (implementation)
* link:../src/main/java/de/cuioss/jwt/token/jwks/JwksLoaderFactory.java[JwksLoaderFactory] (factory)

The `JwksLoader` interface handles the retrieval, caching, and rotation of cryptographic keys used for token validation.

==== Interface Definition

The JwksLoader interface defines the following methods:

* `Optional<Key> getKey(String kid)` - Gets a key by its ID
* `Optional<Key> getFirstKey()` - Gets the first available key
* `Set<String> keySet()` - Gets the set of available key IDs

The library provides several implementations of the JwksLoader interface:

1. `HttpJwksLoader` - Loads JWKS from an HTTP endpoint with caching and automatic refresh
2. `JWKSKeyLoader` - Loads JWKS from a string content (used internally by other loaders)

The implementations handle HTTP communication with JWKS endpoints, caching keys for performance, refreshing keys periodically, and error handling for HTTP communication.

Refer to the implementation and associated JavaDoc for detailed behavior.

=== ParsedToken
_See Requirement link:../Requirements.adoc#CUI-JWT-1.2[CUI-JWT-1.2: Token Types]_

==== Status: IMPLEMENTED

This specification has been implemented in the following classes:

* link:../src/main/java/de/cuioss/jwt/token/ParsedToken.java[ParsedToken] (abstract base class)
* link:../src/main/java/de/cuioss/jwt/token/ParsedAccessToken.java[ParsedAccessToken] (interface)
* link:../src/main/java/de/cuioss/jwt/token/ParsedIdToken.java[ParsedIdToken] (interface)
* link:../src/main/java/de/cuioss/jwt/token/ParsedRefreshToken.java[ParsedRefreshToken] (interface)

The `ParsedToken` is an abstract base class for parsed JWT token representations. It provides common functionality for working with JWT tokens.

==== Class Hierarchy

* `ParsedToken` - Base class for all token types
  * `ParsedAccessToken` - Represents an OAuth 2.0 access token
  * `ParsedIdToken` - Represents an OpenID Connect ID token
  * `ParsedRefreshToken` - Represents an OAuth 2.0 refresh token

The implementation provides access to common JWT claims (issuer, subject, expiration time, issued at, audience, token ID), provides type-specific functionality for different token types, and validates token claims based on token type.

Refer to the implementation and associated JavaDoc for detailed behavior.
