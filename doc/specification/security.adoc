= JWT Token Handling Security
:toc:
:toclevels: 3
:toc-title: Table of Contents
:sectnums:

link:../Specification.adoc[Back to Main Specification]

== Overview
_See Requirement link:../Requirements.adoc#CUI-JWT-8[CUI-JWT-8: Security]_

This document provides detailed specifications for the security aspects of the JWT token handling library.

== Security Measures

=== Signature Validation
_See Requirement link:../Requirements.adoc#CUI-JWT-1.3[CUI-JWT-1.3: Signature Validation]_

==== Status: IMPLEMENTED

This specification has been implemented in the following classes:

* link:../src/main/java/de/cuioss/jwt/token/JwksAwareTokenParserImpl.java[JwksAwareTokenParserImpl]
* link:../src/main/java/de/cuioss/jwt/token/JwtParser.java[JwtParser]

The implementation is verified by the following tests:

* link:../src/test/java/de/cuioss/jwt/token/SignatureValidationTest.java[SignatureValidationTest] - Comprehensive tests for signature validation, including:
** Validation of tokens with supported algorithms (RS256)
** Rejection of tokens with unsupported algorithms (HS256, HS384, HS512, none)
** Protection against algorithm confusion attacks
* link:../src/test/java/de/cuioss/jwt/token/JwksAwareTokenParserImplTest.java[JwksAwareTokenParserImplTest] - Tests for the JwksAwareTokenParserImpl class

The library supports the following signature algorithms as specified in the requirements:

==== Supported Algorithms

* RS256 (RSASSA-PKCS1-v1_5 using SHA-256)
* RS384 (RSASSA-PKCS1-v1_5 using SHA-384)
* RS512 (RSASSA-PKCS1-v1_5 using SHA-512)
* PS256 (RSASSA-PSS using SHA-256 and MGF1 with SHA-256)
* PS384 (RSASSA-PSS using SHA-384 and MGF1 with SHA-384)
* PS512 (RSASSA-PSS using SHA-512 and MGF1 with SHA-512)
* ES256 (ECDSA using P-256 and SHA-256)
* ES384 (ECDSA using P-384 and SHA-384)
* ES512 (ECDSA using P-521 and SHA-512)

==== Rejected Algorithms

The following algorithms are explicitly rejected for security reasons:

* HS256 (HMAC using SHA-256)
* HS384 (HMAC using SHA-384)
* HS512 (HMAC using SHA-512)
* None (Unsecured JWT)

Refer to the implementation and associated JavaDoc for detailed behavior.

=== Token Size Limits
_See Requirement link:../Requirements.adoc#CUI-JWT-8.1[CUI-JWT-8.1: Token Size Limits]_

==== Status: IMPLEMENTED

This specification has been implemented in the following classes:

* link:../src/main/java/de/cuioss/jwt/token/util/NonValidatingJwtParser.java[NonValidatingJwtParser]
* link:../src/main/java/de/cuioss/jwt/token/TokenFactory.java[TokenFactory]

To prevent denial of service attacks, the library enforces a maximum token size of 8KB.

The implementation checks the token size before parsing and rejects tokens larger than the configured limit. The default limit is set to 8KB as recommended by OAuth 2.0 JWT BCP Section 3.11.

Refer to the implementation and associated JavaDoc for detailed behavior.

=== Safe Parsing
_See Requirement link:../Requirements.adoc#CUI-JWT-8.2[CUI-JWT-8.2: Safe Parsing]_

==== Status: PARTIALLY IMPLEMENTED

This specification has been partially implemented in the following classes:

* link:../src/main/java/de/cuioss/jwt/token/util/NonValidatingJwtParser.java[NonValidatingJwtParser]

The `NonValidatingJwtParser` class already implements several safe parsing features:

1. Token size validation to prevent memory exhaustion attacks
2. Payload size validation for JSON parsing
3. Standard Base64 decoding for JWT parts
4. Proper character encoding handling (using StandardCharsets.UTF_8)
5. Input validation (checking for empty tokens)
6. Format validation (checking for correct number of parts)
7. Comprehensive error handling with appropriate logging
8. Proper resource management (using try-with-resources for JsonReader)

==== Implementation Details

To complete the safe parsing implementation, the `NonValidatingJwtParser` should be extended with:

1. Additional protection against JSON parsing attacks:
   * JSON depth limits
   * JSON object size limits
   * Protection against duplicate keys
2. Input sanitization for untrusted data
3. Stronger validation of token structure and content

[source,java]
----
private Optional<JsonObject> decodeJsonPart(String encodedPart) {
    try {
        byte[] decoded = Base64.getUrlDecoder().decode(encodedPart);

        if (decoded.length > maxPayloadSize) {
            LOGGER.warn(JWTTokenLogMessages.WARN.DECODED_PART_SIZE_EXCEEDED.format(maxPayloadSize));
            return Optional.empty();
        }

        // Configure JSON parser with security settings
        Map<String, Object> config = new HashMap<>();
        config.put("jakarta.json.stream.maxStringSize", maxStringSize);
        config.put("jakarta.json.stream.maxArraySize", maxArraySize);
        config.put("jakarta.json.stream.maxDepth", maxDepth);

        // Parse the part as JSON with security settings
        try (JsonReader reader = Json.createReaderFactory(config)
                .createReader(new StringReader(new String(decoded, StandardCharsets.UTF_8)))) {
            return Optional.of(reader.readObject());
        }
    } catch (Exception e) {
        LOGGER.warn(e, JWTTokenLogMessages.WARN.FAILED_TO_DECODE_PART.format(e.getMessage()));
        return Optional.empty();
    }
}
----

=== Claims Validation
_See Requirement link:../Requirements.adoc#CUI-JWT-8.4[CUI-JWT-8.4: Claims Validation]_

==== Status: IMPLEMENTED

This specification has been implemented in the following classes:

* link:../src/main/java/de/cuioss/jwt/token/ClaimValidator.java[ClaimValidator]
* link:../src/main/java/de/cuioss/jwt/token/JwksAwareTokenParserImpl.java[JwksAwareTokenParserImpl]

The library implements comprehensive validation for standard JWT claims as defined in RFC 7519.

==== Required Claims

* Issuer (iss)
* Subject (sub)
* Expiration Time (exp)
* Issued At (iat)

==== Implementation Details

The claims validation implementation:

1. Verifies that required claims are present
2. Validates claim values according to RFC 7519
3. Implements additional validation for specific token types

The implementation uses a package-private `ClaimValidator` class that is instantiated by the `JwksAwareTokenParserImpl` and used during token parsing to validate all required claims.

Refer to the implementation and associated JavaDoc for detailed behavior.

=== Secure Communication
_See Requirement link:../Requirements.adoc#CUI-JWT-8.3[CUI-JWT-8.3: Secure Communication]_

==== Status: NOT IMPLEMENTED

The library needs to enforce secure communication for key retrieval by requiring TLS 1.2 or higher.

==== Implementation Details

The secure communication implementation will:

1. Configure the HTTP client to use TLS 1.2 or higher
2. Verify SSL/TLS certificates
3. Implement connection timeouts to prevent hanging connections

[source,java]
----
private HttpClient createSecureHttpClient() {
    LOGGER.debug("Creating secure HTTP client");

    try {
        SSLContext sslContext = SSLContext.getInstance("TLSv1.2");
        sslContext.init(null, null, null);

        return HttpClient.newBuilder()
            .sslContext(sslContext)
            .connectTimeout(Duration.ofSeconds(10))
            .build();
    } catch (Exception e) {
        LOGGER.error(e, ERROR.HTTP_CLIENT_CREATION_FAILED.format(e.getMessage()));
        throw new RuntimeException("Failed to create secure HTTP client", e);
    }
}
----

Note: The current implementation allows any TLS version or relies on VM defaults.

=== Cryptographic Agility
_See Requirement link:../Requirements.adoc#CUI-JWT-8.5[CUI-JWT-8.5: Cryptographic Agility]_

==== Status: NOT IMPLEMENTED

The library needs to implement support for algorithm upgrades without breaking changes to enable cryptographic agility.

==== Implementation Details

The cryptographic agility implementation will:

1. Support multiple signature algorithms
2. Allow configuration of preferred algorithms
3. Support key rotation and algorithm migration

[source,java]
----
private List<String> getPreferredAlgorithms() {
    LOGGER.debug("Getting preferred algorithms");

    // Order algorithms by preference
    return Arrays.asList(
        "ES512", // Most preferred
        "ES384",
        "ES256",
        "PS512",
        "PS384",
        "PS256",
        "RS512",
        "RS384",
        "RS256"  // Least preferred
    );
}
----
