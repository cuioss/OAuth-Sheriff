= Refactoring Opportunities for cui-jwt-token-handling

This document outlines potential refactoring opportunities for the cui-jwt-token-handling project. Each task is actionable and includes a rationale.

== Task Completion Process

After implementing any task in this document, follow these steps:

1. Clean-Up Code: Use "./mvnw -Prewrite-prepare-release rewrite:run" -> verify with "./mvnw clean install" -> Fix if necessary and commit
2. Clean-Up Javadoc: "./mvnw clean install -Pjavadoc" -> Fix all errors and warnings, verify until they are all corrected
3. Verify the documentation is updated correctly
4. Commit the changes with a git commit. Use the task name (e.g., "C1. Document Bouncy Castle Usage") as the commit message
5. Check the checkbox for the completed task

== Task List

Each task is numbered with a prefix indicating its category (e.g., "implement task C4" for code-specific task 4).

== Code Structure and Design

=== C1. Document Bouncy Castle Usage
[x] *Priority:* Medium

*Description:* Ensure that the usage of Bouncy Castle for cryptographic operations is consistently documented throughout the codebase and documentation.

*Rationale:* Clear documentation of cryptographic dependencies is important for security reviews and understanding the library's security model.

=== C2. Extract Interface for TokenFactory
[ ] *Priority:* Medium

*Description:* Create an interface for TokenFactory to improve testability and allow for alternative implementations.

*Rationale:* Following the interface segregation principle would make the code more modular and easier to test with mocks.

=== C3. Implement Builder Pattern Consistently
[ ] *Priority:* Medium

*Description:* Ensure all complex objects use the builder pattern consistently. Some classes already use Lombok's @Builder annotation, but this pattern could be extended to other classes.

*Rationale:* Consistent use of the builder pattern improves code readability and maintainability.

=== C4. Change TokenFactory Constructor to Use Ellipsis for IssuerConfig
[x] *Priority:* Medium

*Description:* Change the constructor in de.cuioss.jwt.token.TokenFactory#TokenFactory to use an ellipsis for IssuerConfig: TokenFactory(@TokenFactoryConfig config, IssuerConfig ... issuerConfigs). Adapt tests and configuration.

*Rationale:* Using an ellipsis (varargs) instead of a Collection provides a more convenient API for users when they have a small number of issuer configurations.

=== C5. Enhance TokenFactoryConfig with NonValidatingJwtParser Attributes
[x] *Priority:* Medium

*Description:* Add all attributes from NonValidatingJwtParser to the TokenFactoryConfig class, including maxStringSize, maxArraySize, and maxDepth constants. Add the creation and caching of createJsonReaderFactory. After implementing, pass only the TokenFactoryConfig object to NonValidatingJwtParser instead of individual attributes. Adapt tests and documentation accordingly.

*Rationale:* Centralizing configuration in TokenFactoryConfig improves maintainability and reduces duplication. It also provides a single point of configuration for all security-related settings.

== Performance Improvements

=== P1. Optimize Token Validation Pipeline
[ ] *Priority:* Medium

*Description:* Review the token validation pipeline for potential performance optimizations, particularly for high-throughput scenarios.

*Rationale:* The current pipeline approach is well-structured but might benefit from optimizations like early termination for common failure cases.

=== P2. Enhance Caching Strategy
[ ] *Priority:* Medium

*Description:* Review and potentially enhance the caching strategy for JWKS keys to reduce network calls and improve performance.

*Rationale:* Efficient caching is critical for performance in multi-issuer environments.

== Security Enhancements

=== S1. Implement Key Rotation Alerts
[ ] *Priority:* High

*Description:* Add monitoring and alerting for key rotation events to ensure timely response to key changes.

*Rationale:* Proactive monitoring of key rotation helps prevent authentication failures during key transitions.

=== S2. Add Support for Additional Cryptographic Algorithms
[ ] *Priority:* Medium

*Description:* Extend AlgorithmPreferences to support additional modern cryptographic algorithms as they become standardized.

*Rationale:* Staying current with cryptographic standards is essential for long-term security.

=== S3. Implement Rate Limiting for Token Validation
[ ] *Priority:* Medium

*Description:* Add rate limiting capabilities to prevent denial-of-service attacks through excessive token validation requests.

*Rationale:* Rate limiting is a standard security practice to prevent resource exhaustion.

== Testing Improvements

=== T1. Increase Test Coverage for Edge Cases
[ ] *Priority:* High

*Description:* Add more tests for edge cases, particularly around token expiration, clock skew, and network failures.

*Rationale:* Comprehensive testing of edge cases improves reliability in production environments.

=== T2. Add Performance Benchmarks
[ ] *Priority:* Medium

*Description:* Implement performance benchmarks to measure and track token validation performance over time.

*Rationale:* Performance benchmarks help identify regressions and validate optimizations.

=== T3. Enhance Integration Testing
[ ] *Priority:* Medium

*Description:* Expand integration tests with additional identity providers beyond Keycloak.

*Rationale:* Testing with multiple providers ensures compatibility in diverse environments.

== Dependency Management

=== D1. Update to Latest Stable Dependencies
[ ] *Priority:* Medium

*Description:* Regularly update dependencies to their latest stable versions to benefit from bug fixes and security patches.

*Rationale:* Keeping dependencies current reduces security vulnerabilities and ensures access to the latest features.

=== D2. Minimize Runtime Dependencies
[ ] *Priority:* Low

*Description:* Review dependencies and mark appropriate libraries as optional or provided scope to reduce the deployment footprint.

*Rationale:* Minimizing runtime dependencies reduces potential conflicts and improves deployment flexibility.

== Documentation Improvements

=== DOC1. Create Comprehensive JavaDoc
[ ] *Priority:* High

*Description:* Ensure all public classes and methods have comprehensive JavaDoc comments, including examples where appropriate.

*Rationale:* Complete documentation improves usability and reduces the learning curve for new developers.

=== DOC2. Add Architecture Decision Records (ADRs)
[ ] *Priority:* Medium

*Description:* Document key architectural decisions, particularly around security choices and multi-issuer support.

*Rationale:* ADRs provide context for future maintainers and help preserve institutional knowledge.

=== DOC3. Create Usage Examples
[ ] *Priority:* Medium

*Description:* Develop additional usage examples for common scenarios, particularly for multi-issuer environments.

*Rationale:* Examples help users understand how to effectively use the library in real-world situations.

== Future Enhancements

=== F1. Support for JWT Token Issuance
[ ] *Priority:* Low

*Description:* Consider adding support for JWT token issuance in addition to validation.

*Rationale:* This would make the library more comprehensive and useful for a wider range of use cases.

=== F2. Add Support for OAuth 2.1 and OpenID Connect 2.0
[ ] *Priority:* Low

*Description:* Plan for supporting upcoming OAuth 2.1 and OpenID Connect 2.0 standards.

*Rationale:* Staying current with evolving standards ensures long-term relevance of the library.

=== F3. Implement Pluggable Validation Rules
[ ] *Priority:* Medium

*Description:* Create a pluggable system for custom validation rules to allow users to extend the validation pipeline.

*Rationale:* This would increase flexibility and allow for domain-specific validation requirements.
