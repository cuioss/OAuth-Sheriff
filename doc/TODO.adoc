= JWT Validation Security TODO List
:toc:
:toclevels: 3
:toc-title: Table of Contents
:sectnums:

link:Specification.adoc[Back to Main Specification]

== Overview

This document contains identified security tasks and improvements for the JWT validation library based on the analysis of common JWT vulnerabilities and attacks. Each item is prioritized based on its security impact and implementation complexity.

The following symbols are used for progress tracking:
[%header]
|===
|Symbol |Meaning
|[ ] |Not started
|[/] |In progress
|[x] |Completed
|===

== Security Test Coverage Enhancement

=== 1. Mutable Claims Test

*Priority:* Low
*Status:* [x] COMPLETED

*Description:*
Create tests to verify the library's handling of potentially mutable claims, focusing on the use of `sub` for user identification instead of mutable claims like email.

*Related to:* link:security/oauth-security-analysis.adoc#_mutable_claims_attack[Mutable Claims Attack]

*Implementation Plan:*

1. [x] Enhance `TokenClaimValidatorTest` to include specific tests for subject claim validation
2. [x] Implement tests for:
** Validating tokens with valid subject claims
** Rejecting tokens with missing subject claims
** Documenting behavior with empty subject claims
** Validating tokens with mutable claims
3. [x] Run `./mvnw -Ppre-commit clean verify` to fix all javadoc warnings if there are any
4. [x] Update the corresponding section in link:security/oauth-security-analysis.adoc[oauth-security-analysis.adoc]: Set status to MITIGATED and link the corresponding test
5. [x] Commit the changes to git with a meaningful commit message

*References:*
* https://blog.doyensec.com/2025/01/30/oauth-common-vulnerabilities.html
* https://learn.microsoft.com/en-us/entra/identity-platform/claims-validation#validate-the-subject

== Documentation Enhancement

=== 1. JWT Attack Mitigation Documentation

*Priority:* High
*Status:* [/] IN PROGRESS

*Description:*
Enhance the security documentation to clearly describe how the library mitigates each of the common JWT attacks.

*Related to:* link:security/jwt-attacks-analysis.adoc[JWT Attacks Analysis]

*Implementation Plan:*

1. [ ] Update `doc/specification/security.adoc` to reference the PentesterLab article
2. [ ] Create a new section for each attack vector
3. [ ] Document the mitigation approach implemented in the library
4. [ ] Link to relevant test classes that verify the mitigation
5. [ ] Run `./mvnw -Ppre-commit clean verify` to fix all javadoc warnings if there are any
6. [ ] Update the corresponding sections in link:security/jwt-attacks-analysis.adoc[jwt-attacks-analysis.adoc] to ensure consistency
7. [ ] Commit the changes to git with a meaningful commit message

*References:*
* https://pentesterlab.com/blog/jwt-vulnerabilities-attacks-guide

=== 2. OAuth Security Considerations Documentation

*Priority:* High
*Status:* [/] IN PROGRESS

*Description:*
Enhance the security documentation to clearly describe how the library addresses OAuth-specific security considerations.

*Related to:* link:security/oauth-security-analysis.adoc[OAuth Security Analysis]

*Implementation Plan:*

1. [ ] Update `doc/specification/security.adoc` to reference the Doyensec article
2. [ ] Create a new section for each OAuth vulnerability
3. [ ] Document the mitigation approach implemented in the library
4. [ ] Link to relevant test classes that verify the mitigation
5. [ ] Run `./mvnw -Ppre-commit clean verify` to fix all javadoc warnings if there are any
6. [ ] Update the corresponding sections in link:security/oauth-security-analysis.adoc[oauth-security-analysis.adoc] to ensure consistency
7. [ ] Commit the changes to git with a meaningful commit message

*References:*
* https://blog.doyensec.com/2025/01/30/oauth-common-vulnerabilities.html

=== 3. JWT Security Best Practices Guide

*Priority:* Medium
*Status:* [ ] TODO

*Description:*
Create a comprehensive guide for users of the library on JWT security best practices.

*Related to:* link:security/jwt-attacks-analysis.adoc[JWT Attacks Analysis] and link:security/oauth-security-analysis.adoc[OAuth Security Analysis]

*Implementation Plan:*

1. [ ] Create a new document `doc/jwt-security-best-practices.adoc`
2. [ ] Include sections on:
** Secure token handling on the client
** Proper configuration of the library
** Key management best practices
** Logging and monitoring recommendations
** Common misconfigurations to avoid
3. [ ] Run `./mvnw -Ppre-commit clean verify` to fix all javadoc warnings if there are any
4. [ ] Cross-reference with link:security/jwt-attacks-analysis.adoc[jwt-attacks-analysis.adoc] and link:security/oauth-security-analysis.adoc[oauth-security-analysis.adoc]
5. [ ] Commit the changes to git with a meaningful commit message

*References:*
* https://auth0.com/blog/a-look-at-the-latest-draft-for-jwt-bcp/
* https://datatracker.ietf.org/doc/html/draft-ietf-oauth-jwt-bcp

== Implementation Enhancements

=== 1. Enhanced JWK Header Validation

*Priority:* Medium
*Status:* [ ] TODO

*Description:*
Implement explicit validation and rejection of embedded JWK, JKU, and X5U headers in tokens.

*Related to:* link:security/jwt-attacks-analysis.adoc#_6_embedded_jwk_cve_2018_0114[Embedded JWK Attack] and link:security/jwt-attacks-analysis.adoc#_7_jku_x5u_header_abuse[JKU/X5U Header Abuse]

*Implementation Plan:*

1. [ ] Update `TokenHeaderValidator` to explicitly check for and reject these headers
2. [ ] Add appropriate security events for attempted attacks
3. [ ] Ensure proper logging of rejection events
4. [ ] Run `./mvnw -Ppre-commit clean verify` to fix all javadoc warnings if there are any
5. [ ] Update the corresponding sections in link:security/jwt-attacks-analysis.adoc[jwt-attacks-analysis.adoc]: Set status to MITIGATED and link the corresponding implementation
6. [ ] Commit the changes to git with a meaningful commit message

*References:*
* https://pentesterlab.com/blog/jwt-vulnerabilities-attacks-guide


=== 2. Enhanced Scope Validation

*Priority:* Medium
*Status:* [ ] TODO

*Description:*
Improve the scope validation capabilities to better protect against scope upgrade attacks.

*Related to:* link:security/oauth-security-analysis.adoc#_scope_upgrade_attack[Scope Upgrade Attack]

*Implementation Plan:*

1. [ ] Document best practices for scope validation in client applications
2. [ ] Update the corresponding section in link:security/oauth-security-analysis.adoc[oauth-security-analysis.adoc]: Set status to MITIGATED and link the corresponding implementation
3. [ ] Commit the changes to git with a meaningful commit message

*References:*
* https://blog.doyensec.com/2025/01/30/oauth-common-vulnerabilities.html
* https://datatracker.ietf.org/doc/html/rfc6749#section-3.3
