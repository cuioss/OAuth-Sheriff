= JWT Token Handling TODO List
:toc:
:toclevels: 3
:toc-title: Table of Contents
:sectnums:

== Overview

This document lists the actionable tasks that need to be completed to fully implement the JWT token handling library according to the specifications. Tasks are ordered by priority and implementation status.

== Implementation Tasks

=== Core Components

==== Token Structure and Types
_See Requirement CUI-JWT-1.1: Token Structure and CUI-JWT-1.2: Token Types in link:Requirements.adoc[Requirements]_

* [x] Implement support for standard JWT token structure with header, payload, and signature
  * _Implemented in ParsedToken.java and its subclasses_
  * _See link:../src/main/java/de/cuioss/jwt/token/ParsedToken.java[ParsedToken.java]_
* [x] Implement proper handling of different token types (access, ID, refresh)
  * _Implemented in ParsedAccessToken.java, ParsedIdToken.java, and ParsedRefreshToken.java_
  * _See link:../src/main/java/de/cuioss/jwt/token/ParsedToken.java[ParsedToken.java]_

==== Base Token Functionality
_See Requirement CUI-JWT-2.1: Base Token Functionality in link:Requirements.adoc[Requirements]_

* [x] Implement expiration checking (exp claim)
  * _Implemented in ParsedToken.java with isExpired() and willExpireInSeconds() methods_
* [x] Implement issuer information (iss claim)
  * _Implemented in ParsedToken.java with getIssuer() method_
* [x] Implement subject information (sub claim)
  * _Implemented in ParsedToken.java with getSubject() method_
* [x] Implement not before time (nbf claim)
  * _Implemented in ParsedToken.java with getNotBeforeTime() method_
* [x] Implement issued at time (iat claim)
  * _Implemented in ParsedToken.java with getIssuedAtTime() method_
* [x] Implement JWT ID (jti claim)
  * _Implemented in ParsedToken.java with getTokenId() method_
* [ ] Implement audience validation (aud claim)
  * _Required by CUI-JWT-8.4: Claims Validation_
  * _JsonWebToken interface has getAudience() method but validation is not implemented in ClaimValidator_

==== Key Caching and Rotation
_See Requirement CUI-JWT-4.2: Key Caching and CUI-JWT-4.3: Key Rotation in link:Requirements.adoc[Requirements]_

* [x] Implement key caching with configurable cache expiration
  * _Implemented in HttpJwksLoader.java using Caffeine cache with configurable expiration_
  * _See link:../src/main/java/de/cuioss/jwt/token/jwks/HttpJwksLoader.java[HttpJwksLoader.java]_
* [x] Implement automatic key rotation based on configurable refresh intervals
  * _Implemented in HttpJwksLoader.java with refreshIntervalSeconds parameter_
  * _See link:../src/main/java/de/cuioss/jwt/token/jwks/HttpJwksLoader.java[HttpJwksLoader.java]_

==== Local Key Support
_See Requirement CUI-JWT-4.4: Local Key Support in link:Requirements.adoc[Requirements]_

* [x] Implement support for local key configuration for testing or offline scenarios
  * _Implemented in JwksLoaderFactory.java with createFileLoader() and createInMemoryLoader() methods_
  * _See link:../src/main/java/de/cuioss/jwt/token/jwks/JwksLoaderFactory.java[JwksLoaderFactory.java]_

==== Token Size Validation
_See Requirement CUI-JWT-8.1: Token Size Limits in link:Requirements.adoc[Requirements] and link:specification/token-size-validation.adoc[Token Size Validation Specification]_

* [x] Implement token size validation
  * _Implemented in NonValidatingJwtParser.java with maxTokenSize and maxPayloadSize parameters_
  * _See link:../src/main/java/de/cuioss/jwt/token/util/NonValidatingJwtParser.java[NonValidatingJwtParser.java]_
* [x] Update token size limit to 8KB as recommended by OAuth 2.0 JWT BCP Section 3.11
  * _Updated in NonValidatingJwtParser.java with DEFAULT_MAX_TOKEN_SIZE and DEFAULT_MAX_PAYLOAD_SIZE set to 8KB_
* [x] Implement a builder pattern for TokenFactory to allow passing token size parameters to NonValidatingJwtParser
  * _Implemented in TokenFactory.java with builder() method and Builder class_
  * _See link:../src/main/java/de/cuioss/jwt/token/TokenFactory.java[TokenFactory.java]_
* [x] Update MultiIssuerJwtParser to support configuring the NonValidatingJwtParser
  * _Implemented in MultiIssuerJwtParser.java with configureInspectionParser() method_
  * _See link:../src/main/java/de/cuioss/jwt/token/util/MultiIssuerJwtParser.java[MultiIssuerJwtParser.java]_

==== Token Decryption Support
_See Requirement CUI-JWT-1.4: Token Decryption in link:Requirements.adoc[Requirements] and link:specification/token-decryption.adoc[Token Decryption Specification]_

* [x] Create a specification document for token decryption support
  * _Implemented in link:specification/token-decryption.adoc[Token Decryption Specification]_
* [ ] Implement support for decrypting JWT tokens (JWE) as defined in RFC 7516
  * _Note: This is marked as optional for a future version in the requirements_

=== Testing
_See link:specification/testing.adoc#_compliance_with_cui_testing_standards[Compliance with CUI Testing Standards]_

==== Test Coverage Improvements
_See link:specification/testing.adoc#_summary_of_cui_testing_core_standards[Summary of CUI Testing Core Standards]_

* [ ] Implement test coverage reporting in the build process
* [ ] Ensure all public methods have corresponding unit tests
* [ ] Set up coverage thresholds in the build to enforce minimum 80% line coverage

==== Test Structure and Organization
_See link:specification/testing.adoc#_summary_of_cui_testing_core_standards[Summary of CUI Testing Core Standards]_

* [ ] Establish consistent test naming conventions
* [ ] Document and enforce the Arrange-Act-Assert pattern in all tests
* [ ] Establish a consistent structure for test classes
* [ ] Define naming conventions for test methods
* [ ] Group related tests in the same test class

==== Test Data Management
_See link:specification/testing.adoc#_summary_of_cui_testing_core_standards[Summary of CUI Testing Core Standards]_

* [ ] Create reusable test data generators
* [ ] Implement test data builders for complex objects
* [ ] Document best practices for test data management

==== Assertion Improvements
_See link:specification/testing.adoc#_summary_of_cui_testing_core_standards[Summary of CUI Testing Core Standards]_

* [ ] Document best practices for assertions
* [ ] Ensure all assertions include meaningful error messages
* [ ] Use appropriate assertion methods for different scenarios

==== Unit Testing
_See link:specification/testing.adoc#_unit_testing[Unit Testing Specification]_

* [ ] Implement comprehensive unit tests as specified in the testing documentation:
  * [ ] Token parsing tests
  * [ ] Key management tests
  * [ ] Multi-issuer tests
  * [ ] Error handling tests
  * [ ] Edge cases (malformed tokens, expired tokens, etc.)

==== Security Testing
_See Requirement CUI-JWT-12.1: Security Testing in link:Requirements.adoc[Requirements]_

* [ ] Add more comprehensive security testing according to OWASP JWT Security Cheat Sheet
* [ ] Implement tests for:
  * [ ] Token validation bypass
  * [ ] Algorithm confusion attacks
  * [ ] Key disclosure vulnerabilities
  * [ ] Signature verification bypass
  * [ ] Token cracking resistance

==== Performance Testing
_See Requirement CUI-JWT-9: Performance in link:Requirements.adoc[Requirements]_

* [ ] Implement performance tests to verify:
  * [ ] Token parsing performance (at least 1000 tokens per second)
  * [ ] Token validation performance (at least 500 tokens per second)
  * [ ] Key retrieval and caching performance (no more than 100ms overhead per new key)

==== Integration Testing
_See link:specification/testing.adoc#_integration_testing_with_testcontainers[Integration Testing with TestContainers Specification]_

* [ ] Ensure Keycloak integration tests are comprehensive and cover all test cases:
  * [ ] Parse access tokens from Keycloak
  * [ ] Parse ID tokens from Keycloak
  * [ ] Parse refresh tokens from Keycloak
  * [ ] Validate tokens against Keycloak JWKS endpoint
  * [ ] Handle token expiration and validation

==== Logging Tests
_See link:specification/testing.adoc#_logging_tests[Logging Tests Specification]_

* [ ] Implement comprehensive logging tests as specified in the testing documentation:
  * [ ] Success scenario logging tests
  * [ ] Error scenario logging tests
  * [ ] Use cui-test-juli-logger for testing
  * [ ] Test coverage for INFO/WARN/ERROR/FATAL logs

==== Test Maintenance
_See link:specification/testing.adoc#_summary_of_cui_testing_core_standards[Summary of CUI Testing Core Standards]_

* [ ] Establish guidelines for test maintenance
* [ ] Implement CI/CD checks to prevent merging code with failing tests
* [ ] Document the process for updating tests when production code changes

==== Test Independence
_See link:specification/testing.adoc#_summary_of_cui_testing_core_standards[Summary of CUI Testing Core Standards]_

* [ ] Review existing tests for independence issues
* [ ] Add guidelines for ensuring test independence
* [ ] Implement proper test cleanup mechanisms, especially for integration tests

==== Vulnerability Scanning
_See Requirement CUI-JWT-12.5: Vulnerability Scanning in link:Requirements.adoc[Requirements]_

* [ ] Implement regular vulnerability scanning using:
  * [ ] OWASP Dependency Check for third-party dependencies
  * [ ] Static Application Security Testing (SAST) tools
  * [ ] Fuzz testing for input validation
* _Note: These scans should be integrated into the CI/CD pipeline_

==== Compliance Testing
_See Requirement CUI-JWT-12.6: Compliance Testing in link:Requirements.adoc[Requirements]_

* [ ] Implement tests to verify compliance with:
  * [ ] OpenID Connect Certification requirements
  * [ ] RFC 7519 JWT specification
  * [ ] OAuth 2.0 JWT Best Current Practices
* _Note: Compliance tests should verify that the implementation adheres to the standards and best practices_

=== Security

==== Safe Parsing
_See Requirement CUI-JWT-8.2: Safe Parsing in link:Requirements.adoc[Requirements]_

* [ ] Implement safe parsing practices to prevent security vulnerabilities:
  * [ ] Protection against JSON parsing attacks
  * [ ] Protection against injection attacks
  * [ ] Protection against deserialization vulnerabilities
* _Note: The implementation should follow OWASP Top 10 guidelines, particularly A8:2021-Software and Data Integrity Failures_

==== Claims Validation
_See Requirement CUI-JWT-8.4: Claims Validation in link:Requirements.adoc[Requirements]_

* [x] Implement comprehensive validation for required claims as specified in RFC 7519:
  * [x] Subject (sub)
  * [x] Expiration time (exp)
  * [x] Issued at (iat)
  * [ ] Not before time (nbf)
* _Note: Implemented in ClaimValidator.java and used by JwksAwareTokenParserImpl.java_
* _Note: Audience validation is still pending implementation_

==== Secure Communication
_See Requirement CUI-JWT-8.3: Secure Communication in link:Requirements.adoc[Requirements]_

* [ ] Enforce TLS 1.2 or higher for key retrieval as recommended by NIST SP 800-52 Rev. 2
* _Note: Current implementation allows any TLS version or relies on VM defaults_

==== Cryptographic Agility
_See Requirement CUI-JWT-8.5: Cryptographic Agility in link:Requirements.adoc[Requirements]_

* [ ] Implement support for algorithm upgrades without breaking changes
* [ ] Add preferred algorithm ordering to enable graceful migration to stronger algorithms

==== Algorithm Validation
_See Requirement CUI-JWT-1.3: Signature Validation in link:Requirements.adoc[Requirements]_

* [ ] Implement explicit checks for supported/rejected algorithms
* [ ] Reject tokens with unsupported algorithms (HS256, HS384, HS512, None)

==== Token Functionality Enhancements

===== Access Token Functionality
_See Requirement CUI-JWT-2.2: Access Token Functionality in link:Requirements.adoc[Requirements]_

* [x] Implement scope-based authorization (scope claim) as defined in RFC 6749
  * _Implemented in ParsedAccessToken.java with getScopes() and providesScopes() methods_
* [x] Implement role-based authorization (roles or groups claims)
  * _Implemented in ParsedAccessToken.java with getRoles() and hasRole() methods_
* [ ] Enhance resource access information beyond scopes and roles
  * _Current implementation provides scope and role management, but could be enhanced with more specific resource access functionality_

===== ID Token Functionality
_See Requirement CUI-JWT-2.3: ID Token Functionality in link:Requirements.adoc[Requirements]_

* [x] Implement basic ID token parsing and validation
  * _Implemented in ParsedIdToken.java_
* [x] Implement email claim access
  * _Implemented in ParsedIdToken.java with getEmail() method_
* [ ] Implement comprehensive user identity information (name, preferred_username, etc.)
  * _Missing implementation for accessing user identity claims_
* [ ] Implement authentication context information (auth_time, acr, amr, etc.)
  * _Missing implementation for accessing authentication context claims_

===== Refresh Token Functionality
_See Requirement CUI-JWT-2.4: Refresh Token Functionality in link:Requirements.adoc[Requirements]_

* [x] Implement basic refresh token representation
  * _Implemented in ParsedRefreshToken.java_
* [ ] Implement token refresh capabilities as defined in RFC 6749
  * _Missing implementation for token refresh capabilities_
* [ ] Implement token lifecycle management
  * _Missing implementation for token lifecycle management_

=== Logging

==== Log Levels
_See Requirement CUI-JWT-7.1: Log Levels in link:Requirements.adoc[Requirements]_

* [x] Implement ERROR level logging for authentication failures and token validation errors
  * _Implemented throughout the codebase using CuiLogger_
* [x] Implement WARN level logging for suspicious activities and token format issues
  * _Implemented throughout the codebase using CuiLogger_
* [x] Implement INFO level logging for successful token validations and key rotations
  * _Implemented throughout the codebase using CuiLogger_
* [x] Implement DEBUG level logging for detailed token processing information
  * _Implemented throughout the codebase using CuiLogger_
* [x] Implement TRACE level logging for highly detailed debugging information
  * _Implemented throughout the codebase using CuiLogger_

==== Log Content
_See Requirement CUI-JWT-7.2: Log Content in link:Requirements.adoc[Requirements]_

* [x] Include timestamps, event types, source components, and outcome in log messages
  * _Implemented throughout the codebase using CuiLogger_
* [x] Exclude sensitive data such as full tokens, private keys, and passwords from log messages
  * _Implemented throughout the codebase, with token strings only logged at TRACE level_
* [ ] Review log messages to ensure they follow OWASP Logging Cheat Sheet recommendations
  * _Some log messages may need to be reviewed for compliance with OWASP recommendations_

==== Security Event Logging
_See Requirement CUI-JWT-7.3: Security Events in link:Requirements.adoc[Requirements]_

* [x] Implement logging for token validation failures
  * _Implemented in JwksAwareTokenParserImpl.java_
* [x] Implement logging for key rotation events
  * _Implemented in HttpJwksLoader.java_
* [ ] Implement logging for configuration changes
  * _Missing implementation for logging configuration changes_
* [ ] Implement logging for suspicious token usage patterns
  * _Missing implementation for logging suspicious token usage patterns_

== Documentation Tasks

=== Update Specification and Javadoc

* [x] Update the specification to match the actual implementation naming (JwksLoader, JwksLoaderFactory, MultiIssuerJwtParser)
  * _Implemented in Specification.adoc and related files_
* [ ] Ensure all implementation classes are properly documented with references to the requirements they implement
  * _Some classes have proper references to requirements, but others need to be updated_
* [ ] Update class and method Javadoc to include references to the requirements
  * _Some classes have proper references to requirements, but others need to be updated_
