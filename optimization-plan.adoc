= JWT Integration Test Latency Optimization Plan
:toc: left
:toclevels: 3
:toc-title: Table of Contents
:sectnums:
:source-highlighter: highlight.js

== Critical Build Information

**Build Command:** `./mvnw verify -pl cui-jwt-quarkus-parent/quarkus-integration-benchmark -Dskip.benchmark=false`

IMPORTANT: Only add `clean` when the Quarkus container has changed (like during optimization).

**Commit Requirements:** You must only commit if the Maven command executes without errors and warnings, and you verified the results.

== High Priority Tasks

=== ⚠️ **CRITICAL LATENCY FOCUS**

- [ ] **Analyze current latency**: Investigate 153.8ms P95 latency - still too high for 20ms target
- [ ] **Use Flight Recorder**: Analyze problems using flight-recorder (already configured in container)
- [ ] **Verify wrk Best Practices**: Deep web research on current script/structure compliance, especially configuration (10 threads seem low)
- [ ] **Remove JMH code completely**: Remove all JMH dependencies and code from project

== Completed Items

=== Priority 1: Verify Benchmark Calculations ✅ **COMPLETED**
Result: No calculation errors found. Badge scripts correctly format values.

=== Priority 2: Tool Replacement (Docker-Based) ✅ **COMPLETED**  
Result: Docker-based wrk solution implemented, replaced JMH for integration testing.

=== Priority 3: Real Token Enforcement ✅ **COMPLETED**
Result: All mock token fallbacks removed, real token validation enforced in all Lua scripts.

== Executive Summary

=== Current State
- **Current latency**: 153.8ms P95 (from latest wrk results)
- **Target latency**: 20ms (realistic for Apple M4 + Quarkus native)
- **JWT processing baseline**: 5ms (excellent performance)
- **Infrastructure**: Apple M4, containerized Quarkus native runtime

=== Performance Targets
Based on 2024 Quarkus native benchmarks:

- **Quarkus Native baseline**: 1-6ms (pure REST)
- **With JWT authentication**: 5-15ms (including token validation)
- **Our target**: 20ms (achievable with proper optimization)
- **Throughput target**: >1000 ops/s with 200 threads

== Open Tasks (Prioritized by Latency Impact)

=== 1. **Flight Recorder Analysis** (Highest Priority)

- [ ] **Use flight-recorder**: Analyze performance bottlenecks using flight-recorder (already configured in container)
- [ ] **Identify hotspots**: Pinpoint exact causes of 153.8ms latency

=== 2. **wrk Configuration Optimization**

- [ ] **Research wrk best practices**: Deep web research on optimal configuration 
- [ ] **Thread configuration**: 10 threads may be too low for Apple M4 (10+ cores)
- [ ] **Connection optimization**: Verify 200 connections vs threads ratio
- [ ] **Lua script optimization**: Streamline implementation between shell and Lua scripts

=== 3. **JMH Cleanup**

- [ ] **Remove JMH dependencies**: Clean up all JMH code and dependencies from project
- [ ] **Remove unused JMH classes**: Delete benchmark classes no longer needed

=== 4. **Infrastructure Optimization**

- [ ] **Container networking**: Investigate Docker bridge networking overhead
- [ ] **Resource constraints**: Verify CPU/memory limits aren't causing delays
- [ ] **Virtual thread configuration**: Verify proper virtual thread adoption

== Dismissed Items (Do Not Revisit)

=== 6.1. Items Already Ruled Out

==== 1. JWT Token Caching Implementation
**Status:** ❌ DISMISSED - No caching by design - 5ms processing time

==== 2. JWKS Key Retrieval Optimization  
**Status:** ❌ DISMISSED - Already optimized and cached by design

==== 3. Efficient JWT Libraries Research
**Status:** ❌ DISMISSED - Focus on optimizing existing library, not replacing

==== 4. Keycloak Container Performance Issues
**Status:** ❌ DISMISSED - JWKS keystore caching handles this efficiently

==== 5. Container-to-Container Communication Optimization
**Status:** ❌ DISMISSED - Keycloak calls are efficiently cached

==== 6. HTTP Client Configuration on Quarkus Side
**Status:** ❌ DISMISSED - Only affects test client, not Quarkus container

==== 7. Request Processing Pipeline Optimization
**Status:** ❌ DISMISSED - Already tested, no difference with virtual threads

==== 8. Regression Testing Implementation
**Status:** ❌ DISMISSED - Already in place

==== 9. Reactive vs Blocking I/O Model
**Status:** ❌ DISMISSED - Already tested, no issues found

==== 10. Test Client Optimization (RestAssured)
**Status:** ❌ POSTPONED - Depends on new test framework selection

==== 11. 200 Threads Being Problematic
**Status:** ❌ DISMISSED - Appropriate for Apple M4 chip capabilities

==== 12. Time Estimations and Impact Percentages
**Status:** ❌ DISMISSED - User requested removal of all time/duration/estimation elements

