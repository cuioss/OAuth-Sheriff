= Task 9. Create Integration Test Module
:toc:
:toclevels: 3
:toc-title: Table of Contents
:sectnums:

include::task-completion-process.adoc[leveloffset=+1]

== Overview
[ ] *Priority:* High

*Description:* Create a comprehensive integration test module for the Quarkus JWT extension:

. Create a separate integration test module:
+
--
* Separate Maven module for integration tests
* Native container testing with Quarkus
* HTTPS support with generated certificates
* Memory-based JWKS configuration
--
. Implement native container testing:
+
--
* Build native container with Quarkus extension
* Run container in test environment
* Test real-world scenarios with containerized application
--
. Configure HTTPS with certificate generation:
+
--
* Script for generating public/private key pairs
* Self-signed certificates for localhost testing
* Proper certificate management and cleanup
--
. Test health and metrics endpoints:
+
--
* REST Assured integration for endpoint testing
* Health check endpoint validation
* Metrics endpoint verification with Prometheus format
* Error scenarios and edge cases
--
. Provide manual testing scripts:
+
--
* Docker container start/stop scripts
* Environment setup and teardown
* Manual testing procedures
--

*Rationale:* Integration testing is essential for validating that the extension works correctly in real containerized environments. This ensures compatibility with production deployments and verifies that native compilation works properly with all features including HTTPS, health checks, and metrics.

== Implementation Steps

. *Create Integration Test Module Structure*:
+
--
* [ ] Create new Maven module `cui-jwt-quarkus-integration-tests`
* [ ] Configure module dependencies and plugin configuration
* [ ] Setup test application with minimal configuration
* [ ] Configure native image build profiles
--

. *Implement Certificate Generation*:
+
--
* [ ] Create certificate generation script based on nifi-extensions approach
* [ ] Generate localhost certificates with proper SAN (Subject Alternative Names)
* [ ] Create keystore and truststore for HTTPS testing
* [ ] Export certificates in PEM format for container usage
--

. *Configure Memory-Based JWKS*:
+
--
* [ ] Setup in-memory JWKS using test utilities from UnitTesting.adoc
* [ ] Configure IssuerConfig with InMemoryKeyMaterialHandler
* [ ] Create test tokens using TestTokenHolder
* [ ] Implement JWKS endpoint mock for testing
--

. *Implement Native Container Tests*:
+
--
* [ ] Create test application with JWT validation endpoints
* [ ] Configure HTTPS with generated certificates
* [ ] Build native container image using Quarkus
* [ ] Implement container lifecycle management in tests
--

. *Test Health and Metrics Endpoints*:
+
--
* [ ] Use REST Assured for HTTPS endpoint testing
* [ ] Verify health check responses with proper issuer count
* [ ] Validate metrics endpoint Prometheus format
* [ ] Test error scenarios (invalid configuration, missing JWKS)
* [ ] Verify native image compatibility
--

. *Create Manual Testing Scripts*:
+
--
* [ ] Docker start/stop scripts for manual testing
* [ ] Environment setup script with certificate generation
* [ ] README with manual testing procedures
* [ ] Cleanup scripts for test artifacts
--

== Technical Requirements

=== Module Structure
[source]
----
cui-jwt-quarkus-integration-tests/
├── pom.xml
├── README.adoc
├── src/
│   ├── main/
│   │   ├── java/
│   │   │   └── de/cuioss/jwt/integration/
│   │   │       ├── TestApplication.java
│   │   │       ├── config/
│   │   │       │   └── JwtTestConfiguration.java
│   │   │       └── endpoint/
│   │   │           └── ValidationEndpoint.java
│   │   ├── resources/
│   │   │   ├── application.properties
│   │   │   └── application-integration.properties
│   │   └── docker/
│   │       ├── Dockerfile.native
│   │       └── certificates/
│   │           └── generate-certificates.sh
│   └── test/
│       └── java/
│           └── de/cuioss/jwt/integration/
│               ├── NativeIntegrationTest.java
│               ├── HealthCheckIntegrationTest.java
│               ├── MetricsIntegrationTest.java
│               └── HttpsJwtValidationTest.java
├── scripts/
│   ├── start-integration-test.sh
│   ├── stop-integration-test.sh
│   └── setup-environment.sh
└── docker-compose-integration.yml
----

=== Certificate Generation Script
Based on https://github.com/cuioss/nifi-extensions/blob/main/integration-testing/src/main/docker/maintenance/generate-certificates.sh

[source,bash]
----
#!/bin/bash
# Script to generate certificates for JWT Quarkus integration testing
# Generates localhost certificates with proper SAN for HTTPS testing

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
CERT_DIR="${SCRIPT_DIR}/certificates"
KEYSTORE_PASSWORD="integration-test"
TRUSTSTORE_PASSWORD="integration-test"
KEY_PASSWORD="integration-test"
CERT_DNAME="CN=localhost, OU=Integration Testing, O=CUI-JWT, L=Berlin, ST=Berlin, C=DE"
CERT_VALIDITY=365

# Create certificates directory
mkdir -p "${CERT_DIR}"

# Generate keystore with private key and self-signed certificate
keytool -genkeypair \
  -alias localhost \
  -keyalg RSA \
  -keysize 2048 \
  -validity ${CERT_VALIDITY} \
  -dname "${CERT_DNAME}" \
  -ext san=dns:localhost,ip:127.0.0.1,ip:0.0.0.0 \
  -keystore "${CERT_DIR}/keystore.p12" \
  -storetype PKCS12 \
  -storepass "${KEYSTORE_PASSWORD}" \
  -keypass "${KEY_PASSWORD}"

# Export certificate and create truststore
keytool -exportcert \
  -alias localhost \
  -file "${CERT_DIR}/localhost.cer" \
  -keystore "${CERT_DIR}/keystore.p12" \
  -storetype PKCS12 \
  -storepass "${KEYSTORE_PASSWORD}"

# Export to PEM format for container usage
keytool -exportcert \
  -alias localhost \
  -file "${CERT_DIR}/localhost.crt" \
  -keystore "${CERT_DIR}/keystore.p12" \
  -storetype PKCS12 \
  -storepass "${KEYSTORE_PASSWORD}" \
  -rfc

echo "Certificate generation complete for JWT integration testing"
----

=== Memory-Based JWKS Configuration
[source,java]
----
@ApplicationScoped 
public class JwtTestConfiguration {
    
    @Produces
    @ApplicationScoped
    public TestTokenHolder createTestTokenHolder() {
        return TestTokenGenerators.accessTokens().next();
    }
    
    @Produces
    @ApplicationScoped 
    public IssuerConfig createIssuerConfig(TestTokenHolder tokenHolder) {
        // Configure memory-based JWKS using test utilities
        return tokenHolder.getIssuerConfig();
    }
}
----

=== Native Container Test Structure
[source,java]
----
@QuarkusIntegrationTest
@TestHTTPSEndpoint(value = "https://localhost", port = 8443)
class NativeIntegrationTest {
    
    @Test
    void shouldValidateJwtInNativeContainer() {
        // Test JWT validation in native container
        given()
            .trustStore("/path/to/truststore.p12", "integration-test")
            .header("Authorization", "Bearer " + validJwtToken)
        .when()
            .get("/validate")
        .then()
            .statusCode(200)
            .body("valid", equalTo(true));
    }
    
    @Test 
    void shouldExposeHealthChecks() {
        given()
            .trustStore("/path/to/truststore.p12", "integration-test")
        .when()
            .get("/q/health")
        .then()
            .statusCode(200)
            .body("status", equalTo("UP"))
            .body("checks.name", hasItem("jwt-validator"));
    }
    
    @Test
    void shouldExposeMetrics() {
        given()
            .trustStore("/path/to/truststore.p12", "integration-test")
        .when()
            .get("/q/metrics")
        .then()
            .statusCode(200)
            .contentType("text/plain")
            .body(containsString("cui_jwt_validation_errors_total"));
    }
}
----

=== Docker Integration Scripts
[source,bash]
----
#!/bin/bash
# start-integration-test.sh
# Starts the integration test environment

./scripts/setup-environment.sh
docker-compose -f docker-compose-integration.yml up -d
echo "Integration test environment started"
echo "Application available at: https://localhost:8443"
echo "Health checks: https://localhost:8443/q/health"
echo "Metrics: https://localhost:8443/q/metrics"
----

== Task Completion Checklist

*1. Verify Implementation:*
+
--
* [ ] Integration test module builds successfully
* [ ] Native container image builds and starts
* [ ] HTTPS certificates generate and work correctly
* [ ] Memory-based JWKS configuration functions properly
* [ ] All endpoints respond correctly over HTTPS
--

*2. Write Tests:*
+
--
* [ ] Native container integration tests pass
* [ ] Health check endpoint tests validate issuer configuration
* [ ] Metrics endpoint tests verify Prometheus format
* [ ] HTTPS certificate validation works in tests
* [ ] Error scenarios are properly tested
--

*3. Verify Documentation:*
+
--
* [ ] Integration test README documents setup and usage
* [ ] Manual testing procedures are documented
* [ ] Certificate generation process is explained
* [ ] Troubleshooting guide for common issues
--

*4. Update Status:*
+
--
* [ ] Mark the task as completed with [x]
* [ ] Document any specific configuration requirements
* [ ] Note performance characteristics in native mode
--

*5. Make a Full Build:*
+
--
* [ ] Run integration tests: `cd cui-jwt-quarkus-integration-tests && mvn clean verify -Pnative`
** [ ] Verify native container builds successfully
** [ ] Verify all integration tests pass
** [ ] Check HTTPS connectivity and certificate validation
* [ ] Run manual testing: `./scripts/start-integration-test.sh`
** [ ] Verify manual startup procedures work
** [ ] Test health and metrics endpoints manually
** [ ] Verify certificate generation and HTTPS setup
--

== Dependencies

=== Maven Dependencies
[source,xml]
----
<dependencies>
    <!-- Quarkus Test Dependencies -->
    <dependency>
        <groupId>io.quarkus</groupId>
        <artifactId>quarkus-junit5</artifactId>
        <scope>test</scope>
    </dependency>
    <dependency>
        <groupId>io.rest-assured</groupId>
        <artifactId>rest-assured</artifactId>
        <scope>test</scope>
    </dependency>
    
    <!-- JWT Extension Under Test -->
    <dependency>
        <groupId>de.cuioss.jwt</groupId>
        <artifactId>cui-jwt-quarkus</artifactId>
    </dependency>
    
    <!-- Test Utilities -->
    <dependency>
        <groupId>de.cuioss.jwt</groupId>
        <artifactId>cui-jwt-validation</artifactId>
        <classifier>test</classifier>
        <scope>test</scope>
    </dependency>
    
    <!-- HTTPS Support -->
    <dependency>
        <groupId>io.quarkus</groupId>
        <artifactId>quarkus-vertx-http</artifactId>
    </dependency>
    
    <!-- Health and Metrics -->
    <dependency>
        <groupId>io.quarkus</groupId>
        <artifactId>quarkus-smallrye-health</artifactId>
    </dependency>
    <dependency>
        <groupId>io.quarkus</groupId>
        <artifactId>quarkus-micrometer-registry-prometheus</artifactId>
    </dependency>
</dependencies>
----

=== Native Build Profile
[source,xml]
----
<profiles>
    <profile>
        <id>native</id>
        <properties>
            <skipITs>false</skipITs>
            <quarkus.package.type>native</quarkus.package.type>
        </properties>
    </profile>
</profiles>
----

== Success Criteria

1. **Native Container Functionality**: The extension works correctly in native container mode with all features enabled
2. **HTTPS Integration**: HTTPS endpoints work with generated certificates and proper SSL/TLS validation
3. **Memory-based JWKS**: In-memory JWKS configuration works correctly for testing scenarios
4. **Health and Metrics**: Health checks and metrics endpoints function properly in containerized environment
5. **Manual Testing**: Docker scripts allow for easy manual testing and verification
6. **CI/CD Ready**: Tests can be integrated into continuous integration pipelines
7. **Documentation**: Complete setup and usage documentation for integration testing

This integration test module will provide confidence that the JWT Quarkus extension works correctly in production-like containerized environments with proper security configurations.
