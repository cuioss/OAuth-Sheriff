= @ConfigMapping CDI Injection Solution for Quarkus Extensions

== Problem Statement

@ConfigMapping interfaces in Quarkus extensions have known issues with CDI injection that can cause unsatisfied dependency errors:

----
jakarta.enterprise.inject.UnsatisfiedResolutionException: Unsatisfied dependency for type de.cuioss.jwt.quarkus.config.JwtValidationConfig and qualifiers [@Default]
----

== Solution: Direct Config.getConfigMapping() Approach

Instead of CDI injection, use direct `Config.getConfigMapping()` calls to access @ConfigMapping interfaces in Quarkus extensions.

=== Implementation

==== 1. Field Injection Change

*Before (CDI injection - problematic):*

[source,java]
----
@ApplicationScoped
public class TokenValidatorProducer {
    @Inject
    JwtValidationConfig jwtValidationConfig;  // Causes CDI issues
}
----

*After (Config injection - recommended):*

[source,java]
----
@ApplicationScoped 
public class TokenValidatorProducer {
    @Inject
    Config config;  // Standard MicroProfile Config injection
}
----

==== 2. Configuration Access Method

*Implementation:*

[source,java]
----
/**
 * Retrieves the JWT validation configuration using direct ConfigMapping approach.
 * <p>
 * This method uses the recommended pattern for accessing @ConfigMapping interfaces
 * in Quarkus extensions, avoiding CDI injection issues that can occur in extension contexts.
 * </p>
 * <p>
 * The approach follows the pattern documented in:
 * <ul>
 *   <li><a href="https://quarkus.io/guides/config-mappings#accessing-configmapping-from-application">Quarkus ConfigMapping Access Guide</a></li>
 *   <li><a href="https://smallrye.io/smallrye-config/Latest/config/mappings/">SmallRye Config Mappings Documentation</a></li>
 * </ul>
 * </p>
 * 
 * @return the JWT validation configuration instance
 * @throws IllegalStateException if configuration mapping cannot be created
 */
private JwtValidationConfig getJwtValidationConfig() {
    try {
        // Use SmallRyeConfig.getConfigMapping() for direct access to @ConfigMapping interfaces
        // This is the recommended approach in Quarkus extensions to avoid CDI injection issues
        return config.unwrap(io.smallrye.config.SmallRyeConfig.class)
                .getConfigMapping(JwtValidationConfig.class);
    } catch (Exception e) {
        String errorMessage = "Failed to retrieve JWT validation configuration: " + e.getMessage();
        LOGGER.error(errorMessage, e);
        throw new IllegalStateException(errorMessage, e);
    }
}
----

==== 3. Usage Pattern

[source,java]
----
private void validateConfiguration() {
    // Direct ConfigMapping retrieval - recommended approach for Quarkus extensions
    // This avoids CDI injection issues with @ConfigMapping interfaces in extension contexts
    JwtValidationConfig jwtValidationConfig = getJwtValidationConfig();
    
    if (jwtValidationConfig == null) {
        LOGGER.error("JWT validation configuration is required");
        throw new IllegalStateException("JWT validation configuration is required");
    }
    
    // Use the configuration normally
    if (jwtValidationConfig.issuers().isEmpty()) {
        LOGGER.error("At least one issuer configuration is required");
        throw new IllegalStateException("At least one issuer configuration is required");
    }
}
----

== Applied In Files

=== TokenValidatorProducer.java

* *Location:* `cui-jwt-quarkus-parent/cui-jwt-quarkus/src/main/java/de/cuioss/jwt/quarkus/producer/TokenValidatorProducer.java`
* *Changes:*
* Line 63: Changed from `@Inject JwtValidationConfig jwtValidationConfig;` to `@Inject Config config;`
* Lines 155-166: Added `getJwtValidationConfig()` helper method
* Lines 103, 147, 177: Updated usage to call `getJwtValidationConfig()` method

=== CuiJwtDevUIRuntimeService.java

* *Location:* `cui-jwt-quarkus-parent/cui-jwt-quarkus/src/main/java/de/cuioss/jwt/quarkus/runtime/CuiJwtDevUIRuntimeService.java`
* *Changes:*
* Line 53: Changed constructor parameter from `JwtValidationConfig config` to `Config config`
* Lines 253-262: Added `getJwtValidationConfig()` helper method
* Lines 105, 130, 272: Updated usage to call `getJwtValidationConfig()` method

== Why This Approach Works

. *Avoids Extension Context Issues:* @ConfigMapping CDI injection can fail in Quarkus extension contexts due to timing and bean registration complexities

. *Uses Standard MicroProfile Config:* `Config` injection is reliably supported across all Quarkus contexts

. *Direct API Access:* `SmallRyeConfig.getConfigMapping()` directly creates the configuration mapping instance without CDI involvement

. *Exception Safety:* Provides clear error handling and logging when configuration cannot be loaded

== References

* https://quarkus.io/guides/config-mappings#accessing-configmapping-from-application[Quarkus ConfigMapping Access Guide]
* https://smallrye.io/smallrye-config/Latest/config/mappings/[SmallRye Config Mappings Documentation]
* https://github.com/quarkusio/quarkus/issues/29583[Quarkus Issue #29583: ConfigMapping CDI injection in extensions]
* https://quarkus.io/guides/writing-extensions#configuration-mapping[Quarkus Extension Configuration Guide]

== Build Verification

After implementing this solution:
- ✅ Integration tests build successfully
- ✅ Native image compilation starts (no more CDI dependency errors)
- ✅ Extension deployment processor registers correctly
- ✅ Configuration mapping works in runtime

This approach is the *recommended best practice* for accessing @ConfigMapping interfaces in Quarkus extensions.