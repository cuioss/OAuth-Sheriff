= JWT Security Events Metrics Integration

This document describes how security events from JWT validation are integrated with Micrometer in Quarkus applications.

== Overview

The JWT validation library includes a `SecurityEventCounter` that tracks various security events that occur during token validation. These events are exposed as Micrometer metrics in Quarkus applications, allowing you to monitor and alert on security-related incidents.

== Architecture

The integration is implemented through a simple and direct approach:

. The `JwtMetricsCollector` class is injected with the `TokenValidator` and the Micrometer `MeterRegistry`
. On application startup, it initializes counters for each event type in the `SecurityEventCounter`
. A scheduled task periodically polls the `SecurityEventCounter` and updates the metrics accordingly

This approach avoids interceptors or complex proxying, resulting in minimal overhead.

== Available Metrics

The following metrics are available:

|===
|Metric Name |Type |Description |Tags 

|`cui.jwt.validation.errors` |Counter |Number of validation errors by type |event_type, result, category 
|===

=== Metric Tags

Each metric includes relevant tags to enable filtering and drilling down:

* `event_type`: The type of security event (corresponds to `SecurityEventCounter.EventType`)
* `result`: The validation result (always "failure" for error metrics)
* `category`: The category of event (structure, signature, semantic)

== Example Prometheus Queries

----
# Total JWT validation errors
sum(cui_jwt_validation_errors_total)

# Errors by category
sum(cui_jwt_validation_errors_total) by (category)

# Signature verification failures
sum(cui_jwt_validation_errors_total{event_type="SIGNATURE_VERIFICATION_FAILED"})

# Errors over time (rate)
rate(cui_jwt_validation_errors_total[5m])
----

== Alert Examples

[source,yaml]
----
# Alert on high rate of signature failures (potential attack)
- alert: JwtSignatureVerificationFailures
  expr: rate(cui_jwt_validation_errors_total{event_type="SIGNATURE_VERIFICATION_FAILED"}[5m]) > 0.1
  for: 5m
  labels:
    severity: critical
  annotations:
    summary: "JWT signature verification failures detected"
    description: "Potential attack: JWT tokens with invalid signatures are being processed at a high rate"

# Alert on token expiration issues
- alert: JwtTokenExpirationIssues
  expr: rate(cui_jwt_validation_errors_total{event_type="TOKEN_EXPIRED"}[5m]) > 1
  for: 10m
  labels:
    severity: warning
  annotations:
    summary: "High rate of expired JWT tokens"
    description: "Many expired JWT tokens are being processed, clients may need to refresh tokens more frequently"
----

== Using the Metrics in Your Application

These metrics are automatically collected when the cui-jwt-quarkus module is used in your application. To use them:

. Ensure the `quarkus-micrometer` extension is enabled in your application
. Add a registry implementation like `quarkus-micrometer-registry-prometheus` for Prometheus integration

The metrics will be available at the standard Micrometer/Prometheus endpoint: `/q/metrics`

== Grafana Dashboard

A pre-configured Grafana dashboard is available at link:jwt-metrics-grafana-dashboard.json[jwt-metrics-grafana-dashboard.json]. 

To use this dashboard:
1. Open Grafana
2. Navigate to Dashboards &gt; Import
3. Upload the JSON file or paste its contents
4. Select your Prometheus data source
5. Click Import

The dashboard includes panels for:
- JWT validation errors by category
- Error type distribution
- Signature verification failure rate
- Time series for various error types
- Total validation errors by type