= JWT Quarkus Integration Benchmarking
:toc: macro
:toclevels: 3

This module provides integration-level performance benchmarking for the JWT Quarkus extension using containerized environments with **identical performance scoring** to the micro-benchmark module.

toc::[]

== Overview

While the xref:../../cui-jwt-benchmarking/README.adoc[JWT Micro-Benchmarking Module] focuses on in-memory testing of library components, this module provides end-to-end integration performance testing using:

* Native Quarkus application in containers
* Keycloak integration for realistic token issuing
* Memory-based token issuers for testing
* Real HTTP/HTTPS communication patterns

== Configuration

The module is configured to:

* Skip Java compilation during normal builds (no Java artifacts needed)
* Exclude from Sonar analysis (`sonar.skip=true`)
* Build only when integration-benchmarks profile is enabled
* Use the same performance metrics as micro-benchmarks

== Usage

=== Local Testing
[source,bash]
----
# The benchmark build requires the integration-tests profile to build the native executable first.

./mvnw clean package -Pintegration-tests -pl cui-jwt-quarkus-parent/cui-jwt-quarkus-integration-tests

# Run integration benchmarks locally using profile
./mvnw clean verify -pl cui-jwt-quarkus-parent/quarkus-integration-benchmark -Pintegration-benchmarks -DskipTests
----

=== Direct wrk Usage
[source,bash]
----
# Navigate to benchmark directory
cd cui-jwt-quarkus-parent/quarkus-integration-benchmark

# Basic benchmark run
./docker/wrk/run-wrk-benchmark.sh

# Custom configuration (threads, connections, duration, error_rate)
./docker/wrk/run-wrk-benchmark.sh 12 240 60s 5

# Health check baseline
./docker/wrk/run-health-benchmark.sh

# JFR profiling with performance testing
./docker/wrk/run-wrk-with-jfr.sh
----

=== CI/CD Execution
Integration benchmarks are executed automatically via GitHub Actions workflow alongside micro-benchmarks.

== Architecture

The benchmarks run in a containerized environment using **wrk** for HTTP load testing, providing realistic performance measurement of the JWT validation endpoints.

=== Container Setup
* Quarkus native application (target under test)
* Keycloak container for realistic token issuing
* Docker-based wrk benchmarking container
* Shared container network for internal communication

=== Components
* **Docker Container**: `cui-jwt-wrk:latest` with Alpine Linux + wrk + dependencies
* **Shell Scripts**: `run-wrk-benchmark.sh` and `run-health-benchmark.sh` for orchestration
* **Lua Scripts**: `jwt-benchmark.lua` and `health-check.lua` for load testing logic
* **Token Management**: Real JWT tokens from Keycloak with fail-fast validation

=== Performance Metrics

The benchmarks measure HTTP-level performance using **wrk** with the following key metrics:

* **Throughput**: Requests per second (RPS) under concurrent load
* **Latency Distribution**: P50, P90, P95, P99 percentiles in milliseconds
* **Error Rates**: Connection errors, timeouts, and HTTP error responses
* **Health Check Baseline**: System latency without JWT validation overhead

=== wrk Configuration Optimizations

==== Thread Configuration
* **Threads**: 6 (optimized for container environments)
* **Connections**: 180 (30x threads for HTTP/1.1 keep-alive efficiency)
* **Duration**: 30 seconds for stable measurements

==== Network Configuration
* **Docker Network**: Uses container-to-container communication
* **HTTPS**: Full TLS support for production-like testing
* **Keep-alive**: HTTP/1.1 connection reuse for realistic performance

==== Token Management
* **Real Tokens**: Keycloak-issued JWT tokens with proper expiration
* **Fail-fast**: Immediate benchmark termination on first authentication error
* **Multi-realm Support**: Configurable token sources for different test scenarios

=== Benchmark Comparison

[cols="1,1,1", options="header"]
|===
|Aspect |Integration Benchmarks |Micro-Benchmarks

|**Measurement Scope**
|End-to-end HTTP validation
|In-memory library calls

|**Time Scale** 
|Milliseconds (HTTP overhead)
|Microseconds (pure library)

|**Infrastructure**
|Docker containers + Keycloak
|Direct JVM execution

|**Scoring Formula**
|**Identical** (same weights)
|**Identical** (same weights)

|**Results Comparability**
|Relative trends & ratios
|Absolute performance values

|**Use Case**
|System-level performance
|Library optimization
|===

== Results

=== Performance Results Format

Results are automatically:
* Collected in two JSON files: `health-check-results.json` and `jwt-validation-results.json` in `target/benchmark-results`
* Uploaded as GitHub artifacts for historical analysis
* Processed for GitHub Pages visualization
* Displayed as README badges alongside micro-benchmark results

=== JSON Output Format

==== Health Check Results (`health-check-results.json`)
[source,json]
----
{
    "throughput_rps": 19375,
    "latency_p95_ms": 24.3,
    "latency_p99_ms": 31.5,
    "errors": 0,
    "test_type": "health_check"
}
----

==== JWT Validation Results (`jwt-validation-results.json`)
[source,json]
----
{
    "throughput_rps": 519,
    "latency_p95_ms": 479.4,
    "latency_p99_ms": 612.8,
    "errors": 0,
    "connection_errors": 0,
    "fail_fast_triggered": false,
    "success_rate": 100.0
}
----

=== Troubleshooting

==== Common Issues
* **No results file**: Check Docker container logs for Lua script errors
* **Low throughput**: Verify Quarkus container is running and accessible
* **Connection errors**: Ensure proper container networking configuration
* **Token errors**: Validate JWT token format and expiration

==== Performance Debugging
[source,bash]
----
# Test container connectivity
curl -k https://localhost:10443/jwt/validate

# Check container logs
docker compose logs cui-jwt-integration-tests

# Validate JWT tokens
cat target/tokens/benchmark/access_token.txt | head -c 50

# Check benchmark results
ls -la target/benchmark-results/
cat target/benchmark-results/health-check-results.json
cat target/benchmark-results/jwt-validation-results.json

# Manual wrk test
docker run --rm --network cui-jwt-quarkus-integration-tests_jwt-integration \
  cui-jwt-wrk:latest wrk -t4 -c80 -d10s --latency \
  https://cui-jwt-integration-tests:8443/q/health/live
----

== Documentation

=== Performance Scoring
* xref:doc/performance-scoring.adoc[Integration Benchmark Performance Scoring] - Integration-specific implementation details
* xref:../../cui-jwt-benchmarking/doc/performance-scoring.adoc[JWT Performance Scoring System] - Complete methodology and scoring calculations

=== Performance Analysis
* xref:doc/performance-patterns.adoc[Performance Patterns & Anomaly Detection] - Expected behavior patterns, measurement quality standards, and optimization guidelines

=== Related Modules
* xref:../../cui-jwt-benchmarking/README.adoc[JWT Micro-Benchmarking Module] - Library component performance testing
* xref:../cui-jwt-quarkus-integration-tests/README.adoc[JWT Quarkus Integration Tests] - Integration testing infrastructure