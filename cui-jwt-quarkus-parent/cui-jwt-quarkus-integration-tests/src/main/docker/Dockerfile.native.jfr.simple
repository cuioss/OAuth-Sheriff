# Simple Dockerfile for copying pre-built native executable with JFR support
# This approach is much faster as it avoids rebuilding the native image in Docker
FROM quay.io/quarkus/ubi-quarkus-runtime-native:jdk-21

LABEL org.opencontainers.image.title="CUI JWT Integration Tests - JFR"
LABEL org.opencontainers.image.description="Quarkus native application with JFR profiling support"
LABEL org.opencontainers.image.vendor="CUI"
LABEL org.opencontainers.image.version="1.0.0-SNAPSHOT"
LABEL security.scan.required="true"
LABEL performance.jfr.enabled="true"

WORKDIR /app

# Copy pre-built native executable from Maven target directory
COPY target/*-runner /app/application

# Copy certificates and health check script
COPY src/main/docker/health-check.sh /app/health-check.sh
COPY src/main/docker/certificates/localhost.crt /app/certificates/localhost.crt
COPY src/main/docker/certificates/localhost.key /app/certificates/localhost.key
COPY src/main/docker/certificates/localhost-truststore.p12 /app/certificates/localhost-truststore.p12

# Set proper permissions
USER root
RUN chmod +x /app/application && \
    chmod +x /app/health-check.sh && \
    chmod 644 /app/certificates/localhost.crt && \
    chmod 600 /app/certificates/localhost.key && \
    chmod 644 /app/certificates/localhost-truststore.p12

EXPOSE 8443
HEALTHCHECK --interval=15s --timeout=5s --retries=3 --start-period=10s CMD ["/app/health-check.sh"]
USER 1001

# JFR-enabled entrypoint for performance analysis
ENTRYPOINT ["/app/application", \
  "-Djavax.net.ssl.trustStore=/app/certificates/localhost-truststore.p12", \
  "-Djavax.net.ssl.trustStorePassword=localhost-trust", \
  "-Djavax.net.ssl.trustStoreType=PKCS12", \
  "-Djdk.tls.rejectClientInitiatedRenegotiation=true", \
  "-Djavax.net.ssl.sessionCacheSize=20480"]