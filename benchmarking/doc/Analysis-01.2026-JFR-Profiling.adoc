= JFR Profiling Analysis - January 2026
:toc:
:toc-placement: preamble
:toclevels: 3

== Executive Summary

JFR (Java Flight Recorder) profiling of the OAuth Sheriff integration tests under load provides CPU hotspot analysis for the JWT validation endpoint.

=== Recording Configuration

* **Platform**: Apple M4, 10 CPU cores
* **Runtime**: Mandrel jdk-25 native image
* **Framework**: Quarkus 3.27.2 (LTS)
* **JFR Settings**: `profile` preset, 240 seconds duration
* **Load**: WRK benchmark with 50 concurrent connections

=== Recording Statistics

[source]
----
Recording Duration: 240 seconds
Total Execution Samples: 48,027
Unique Hot Methods: 3,181
----

== CPU Hotspot Analysis

The following table shows methods at the **top of the call stack** when execution samples were taken. These are the methods actively consuming CPU.

=== Top 15 Hot Methods

[cols="1,3,1,1", options="header"]
|===
| Rank | Method | Samples | %

| 1 | `GHASH.blockMult()` | 5,126 | 10.68%
| 2 | `AESCrypt.implEncryptBlock()` | 2,871 | 5.98%
| 3 | `FileOutputStream.writeBytes()` | 1,337 | 2.78%
| 4 | `SocketDispatcher.write0()` | 1,298 | 2.70%
| 5 | `CounterMode.implCrypt()` | 973 | 2.03%
| 6 | `PlatformDependent.getByte()` | 927 | 1.93%
| 7 | `CodeInfoDecoder.lookupCodeInfo()` | 906 | 1.89%
| 8 | `JfrOldObjectSampler.scavenge()` | 840 | 1.75%
| 9 | `Pthread.pthread_cond_timedwait()` | 839 | 1.75%
| 10 | `EPoll.wait()` | 814 | 1.70%
| 11 | `JavaMonitor.tryRelease()` | 545 | 1.14%
| 12 | `EventFD.set0()` | 461 | 0.96%
| 13 | `SocketDispatcher.read0()` | 460 | 0.96%
| 14 | `StringLatin1.charAt()` | 434 | 0.90%
| 15 | `UnmanagedMemoryUtil.copyLongsForward()` | 434 | 0.90%
|===

=== Categorized CPU Usage

[cols="2,1,1,3", options="header"]
|===
| Category | Samples | % | Components

| TLS/Crypto
| 8,970
| 18.7%
| GHASH (5,126), AES (2,871), CounterMode (973)

| Network I/O
| 4,369
| 9.1%
| FileOutputStream (1,337), SocketDispatcher write (1,298), read (460), EPoll (814), EventFD (461)

| JVM Runtime (SubstrateVM)
| ~4,500
| 9.4%
| CodeInfoDecoder, JFR sampling, GC, monitors, memory ops

| Netty Buffers
| ~1,500
| 3.1%
| PlatformDependent, ByteBuf operations

| Quarkus/Arc Framework
| ~600
| 1.3%
| VertxLocalsHelper, RequestHandler, ContextInstances

| Vert.x HTTP
| ~500
| 1.0%
| HttpUtils, header validation

| CUI Sheriff OAuth
| ~160
| 0.3%
| See detailed breakdown below

| BigInteger (RSA)
| 46
| 0.1%
| addOne (31), mulsub (5), montReduce (3), other (7)
|===

== CUI Sheriff OAuth Library Analysis

Methods from `de.cuioss.sheriff.oauth` at top of call stack:

[cols="3,1", options="header"]
|===
| Method | Samples

| `TokenContent.getClaimOption()` | 9
| `CustomAccessLogFilter.filter()` (proxy) | 8
| `VertxHttpServletRequestAdapter.getHeaders()` | 7
| `LogRecordModel.format()` | 7
| `CustomAccessLogFilter.filter()` | 6
| `ClientIpExtractor.extractFromHeader()` | 5
| `CustomAccessLogFilter.formatLogEntry()` | 5
| `BearerTokenProducer.getBearerTokenResult()` | 4
| `AccessTokenContent.getScopes()` | 4
| `CollectionClaimHandler.providesValues()` | 4
| Other methods (41 unique) | ~100
| **Total** | **~160**
|===

Key observations:

* **Logging dominates**: `CustomAccessLogFilter` and logging utilities account for ~50% of CUI library samples
* **Token validation minimal**: `TokenValidator.createAccessToken()` appears only 1 time
* **Token content access**: `TokenContent.getClaimOption()` at 9 samples is the most frequent token operation

== BigInteger / RSA Analysis

RSA signature verification uses BigInteger for modular exponentiation:

[cols="2,1,1", options="header"]
|===
| Method | Samples | %

| `BigInteger.addOne()` | 31 | 0.065%
| `MutableBigInteger.mulsub()` | 5 | 0.010%
| `BigInteger.implMulAddCheck()` | 4 | 0.008%
| `BigInteger.montReduce()` | 3 | 0.006%
| `MutableBigInteger.divideMagnitude()` | 1 | 0.002%
| `BigInteger.subN()` | 1 | 0.002%
| `BigInteger.implMontgomerySquare()` | 1 | 0.002%
| **Total** | **46** | **0.096%**
|===

At 46 samples out of 48,027 (0.1%), BigInteger operations represent minimal CPU usage.

== TLS/HTTPS Encryption

TLS encryption for HTTPS is the largest single CPU consumer:

[cols="2,1,1,2", options="header"]
|===
| Method | Samples | % | Purpose

| `GHASH.blockMult()` | 5,126 | 10.68% | GCM authentication tag
| `AESCrypt.implEncryptBlock()` | 2,871 | 5.98% | AES block encryption
| `CounterMode.implCrypt()` | 973 | 2.03% | CTR mode processing
| **Total** | **8,970** | **18.7%** |
|===

This is the cost of HTTPS transport security, not specific to JWT validation.

== Thread Activity

Threads observed in execution samples:

* `vert.x-eventloop-thread-*` - HTTP request handling
* `vert.x-internal-blocking-*` - Blocking operations
* `executor-thread-*` - Worker pool
* `JFR recorder` / `JFR Periodic Tasks` - Profiling overhead
* `HttpClient-*-SelectorManager` - Outbound HTTP (Keycloak JWKS)

== JFR Analysis Commands

Commands used to extract this data:

[source,bash]
----
# Recording summary
jfr summary jwt-profile.jfr

# Top hot methods (top of stack)
jfr print --events ExecutionSample jwt-profile.jfr | \
  grep -A1 "stackTrace = \[" | grep -v "stackTrace" | \
  sed 's/^[[:space:]]*//' | sort | uniq -c | sort -rn | head -50

# BigInteger samples
jfr print --events ExecutionSample jwt-profile.jfr | \
  grep -A1 "stackTrace = \[" | grep "BigInteger" | sort | uniq -c

# CUI library samples
jfr print --events ExecutionSample jwt-profile.jfr | \
  grep -A1 "stackTrace = \[" | grep "de.cuioss" | sort | uniq -c | sort -rn
----

== Container Configuration

JFR output requires a volume mount due to read-only container filesystem:

[source,yaml]
----
# docker-compose.jfr.yml
services:
  oauth-sheriff-integration-tests:
    image: "oauth-sheriff-integration-tests:jfr"
    volumes:
      - ./target/jfr-output:/tmp/jfr-output:rw
----

== Related Documents

* link:Analysis-01.2026-Integration.adoc[Integration Benchmark Analysis] - Throughput and latency measurements
* link:Analysis-01.2026-Latency-Decomposition.adoc[Latency Decomposition] - Ablation study results
* link:Analysis-01.2026-Micro.adoc[Microbenchmark Analysis] - JMH component-level timings
* link:../oauth-sheriff-quarkus-parent/doc/performance/jfr-profiling-guide.adoc[JFR Profiling Guide] - Setup instructions
