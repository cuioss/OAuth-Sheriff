= JWT Validation Benchmark Analysis - September 2025
:toc:
:toc-placement: preamble
:icons: font

== Executive Summary

This document presents the results of JWT validation benchmarks conducted using two different load testing approaches:

1. **WRK Benchmark**: HTTP-based load testing with WRK (11.8-minute duration)
2. **Quarkus JMH Benchmark**: Java-based micro-benchmarking with JMH (8.5-minute duration)

Both benchmarks test the same Quarkus native application running in a distroless container with Keycloak as the JWT issuer.

== Test Environment

* **Platform**: macOS Darwin 24.6.0 (ARM64)
* **CPU**: 10 cores available
* **Java Version**: OpenJDK 21.0.7 (Temurin)
* **Quarkus**: Native compilation with Mandrel 23.1.8.0
* **Container**: Distroless image (111MB)
* **Keycloak**: Version 26.2.5
* **Test Date**: September 27, 2025

== Benchmark Results Comparison

[cols="3,2,2,3", options="header"]
|===
| Metric | WRK Benchmark | Quarkus JMH Benchmark | Source

3+^h| *Performance Summary* |

| Performance Score
| 83 (Grade B)
| 48 (Grade F)
| benchmark-data.json, key: overview.performanceScore

| Test Duration
| 11.8 minutes
| 8.5 minutes
| Build logs

4+^h| *JWT Validation Performance*

| Throughput
| 7,179.7 ops/s
| 8,117.5 ops/s
| benchmark-data.json, key: benchmarks[].score

| Average Latency
| 5.0 ms
| 3.0 ms
| benchmark-data.json, key: benchmarks[].latency

| P99.9 Latency
| 21.48 ms
| 10.09 ms
| benchmark-data.json, key: benchmarks[].percentiles["99.9"]

| Latency Variability (CV)
| 167.27% CV
| 0.38% error
| benchmark-data.json, key: benchmarks[].variabilityCoefficient/error

4+^h| *Health Check Performance*

| Throughput
| 3,361.93 ops/s
| 9,952.4 ops/s
| benchmark-data.json, key: benchmarks[].throughput

| Average Latency
| 732 μs
| 2.2 ms
| benchmark-data.json, key: benchmarks[].latency

| P99.9 Latency
| 1.78 ms
| 8.39 ms
| benchmark-data.json, key: benchmarks[].percentiles["99.9"]

4+^h| *Health Live Check Performance (WRK only)*

| Throughput
| 2,604.98 ops/s
| N/A
| benchmark-data.json, key: benchmarks[].throughput

| Average Latency
| 940 μs
| N/A
| benchmark-data.json, key: benchmarks[].latency

| P99.9 Latency
| 2.44 ms
| N/A
| benchmark-data.json, key: benchmarks[].percentiles["99.9"]
|===

== Key Findings

=== Performance Characteristics

1. **JWT Validation Performance**
   - WRK shows 7,180 ops/s
   - JMH shows 8,118 ops/s - reasonably close performance
   - Both tests use HTTP calls to the same endpoints
   - JMH shows ~13% higher throughput, likely due to different connection pooling strategies

2. **Health Check Performance**
   - WRK shows 3,362 ops/s
   - JMH shows 9,952 ops/s - significantly higher throughput (~3x)
   - Both tests hit the same HTTP health endpoints
   - Difference likely due to JMH's more aggressive connection pooling and thread management

3. **Startup Performance**
   - Native app starts in ~170-185ms consistently
   - Container adds ~1 second to total startup time

=== Issues Detected

==== WRK Test Issues
- High coefficient of variation (167%) for JWT validation
- Performance grade B (83/100)
- No errors reported in logs

==== JMH Test Issues
- **HTTP Timeout Exception** during healthCheckThroughput iteration 4 of fork 1
- Performance grade F (48/100) - likely due to the timeout failure
- GC allocation rate of 348 MB/sec indicates memory pressure

==== Log Warnings
- Gauge registration warning for http.server.active.connections metric
- JWT validation warnings about missing audience claims (expected for test environment)
- Keycloak SSL certificate warnings (using self-signed certificates)

== Recommendations

1. **Investigate JMH Timeout Issues**
   - The timeout during healthCheckThroughput suggests resource exhaustion
   - Consider reducing thread count (currently 24) or increasing timeout values

2. **Memory Optimization**
   - High GC allocation rate (348 MB/sec) needs investigation
   - Profile memory usage during JWT validation

3. **Connection Pool Tuning**
   - The 3x difference in health check throughput between WRK and JMH suggests connection management issues
   - WRK may need connection pool tuning or keep-alive settings adjustment
   - Consider investigating WRK's connection reuse patterns

4. **Benchmark Configuration**
   - The performance score difference (B vs F) needs investigation
   - Consider aligning test parameters between WRK and JMH
   - Both tests use HTTP, but connection strategies differ significantly

== Test Execution Details

=== WRK Benchmark
- **Full Maven Command**:
```bash
./mvnw clean verify -Pbenchmark -pl benchmarking/benchmark-integration-wrk
```
- Duration: 11.8 minutes
- Result files: `benchmarking/benchmark-integration-wrk/target/benchmark-results/`
- Data location: `benchmarking/benchmark-integration-wrk/target/benchmark-results/gh-pages-ready/data/`

=== Quarkus JMH Benchmark
- **Full Maven Command**:
```bash
./mvnw clean verify -Pbenchmark -pl benchmarking/benchmark-integration-quarkus
```
- Duration: 8.5 minutes
- Configuration:
  * Threads: 24
  * Forks: 2
  * Warmup: 1 iteration × 3s
  * Measurement: 4 iterations × 12s
- Result files: `benchmarking/benchmark-integration-quarkus/target/benchmark-results/`
- Data location: `benchmarking/benchmark-integration-quarkus/target/benchmark-results/gh-pages-ready/data/`

== Conclusion

Both benchmarks successfully completed with the Quarkus native application demonstrating:

- Sub-200ms native startup times
- JWT validation throughput in the thousands of operations per second
- Health check response times in the microsecond to millisecond range

The performance results show reasonable differences between WRK and JMH benchmarks:

- Both tests use HTTP calls to the same endpoints as verified by code analysis
- JWT validation performance is very similar (7,180 vs 8,118 ops/s - 13% difference)
- Health check performance shows larger differences (3,362 vs 9,952 ops/s - 3x difference)
- The differences can be attributed to:
  * Different connection pooling strategies (JMH uses 24 threads vs WRK uses 4)
  * Different keep-alive and connection reuse patterns
  * JMH's more aggressive HTTP client configuration

Unit conversion issue resolved:
- **Fixed**: JMH results were incorrectly reported in ops/ms instead of ops/s
- **Corrected**: 10 ops/ms = 10,000 ops/s (not 10 million ops/s)
- **Impact**: This brings JMH and WRK results into reasonable alignment

Future testing should focus on:

1. **Connection pool optimization** - Investigate why health check performance differs by 3x
2. **Resolve JMH timeout issues** - The timeout failures need investigation
3. **Standardize benchmark parameters** - Consider aligning thread counts for better comparison
4. **Performance consistency** - Address the high latency variability (167% CV) in JWT validation