= JWT Validation Performance Analysis
:toc: left
:toclevels: 2

== Executive Summary

Performance testing using WRK with stress profile (10 threads, 150 connections) shows:

* **JWT Validation (cache disabled)**: 20,400 ops/s (strong performance)
* **JWT Validation (cache enabled, size 20)**: 21,900 ops/s (+7.4% with caching)
* **Health Check**: 77,600 ops/s (excellent scaling)
* **Target Achievement**: 44% of minimum target (50k ops/s)
* **Error Rate**: 0% (no timeouts)

== WRK Stress Profile Results

=== Configuration

* **Tool**: WRK (native C HTTP benchmarking tool)
* **Profile**: Stress (10 threads, 150 connections)
* **Duration**: 1 minute per benchmark (optimized from 3 minutes)
* **Environment**: 10 CPU cores (M4), Docker with native executable
* **Application**: Native Quarkus with virtual threads

=== Performance Results

[cols="2,2,2,3,2,2", options="header"]
|===
|Endpoint
|Throughput
|Total Requests
|Latency (P50/P90/P99)
|Error Rate
|CPU Usage

|JWT Validation (cache OFF)
|20,400 ops/s
|1.22M
|6.30ms / 17.55ms / 39.38ms
|0 timeouts (0%)
|Not measured

|JWT Validation (cache ON, 20)
|21,900 ops/s
|1.31M
|5.88ms / 16.16ms / 39.98ms
|0 timeouts (0%)
|89.9% peak (74.3% avg)

|Health Check
|77,600 ops/s
|4.66M
|1.53ms / 4.79ms / 10.88ms
|0 timeouts (0%)
|56.2% peak (52.2% avg)
|===

=== Resource Utilization

* **CPU**: JWT (cache ON): 89.9% peak (74.3% avg) | Health: 56.2% peak (52.2% avg)
* **Memory**: Heap peak 127.5MB (JWT), 122.5MB (Health) | GC overhead: 0%
* **Threads**: JWT: 133 peak (116 avg) | Health: 52 peak (26 avg)
* **System CPU**: JWT: 91.1% peak | Health: 87.8% peak
* **GC**: Zero overhead (native compilation)

== Performance Analysis

=== Connection Count Investigation Results

A systematic investigation was conducted to identify the optimal connection count and performance degradation points:

[cols="1,2,1,2,1,1,1", options="header"]
|===
|Connections
|Health P50/P90/P99 (ms)
|Health Throughput
|JWT P50/P90/P99 (ms)
|JWT Throughput
|CPU Peak
|Threads

|50 (Default)
|1.0 / 2.48 / 6.27
|37.6K ops/s
|2.61 / 5.75 / 13.6
|16.7K ops/s
|75.7%
|72

|100
|1.63 / 4.73 / 10.81
|47.6K ops/s
|5.23 / 14.97 / 36.42
|16.2K ops/s
|87.1%
|116

|150 (Stress)
|1.53 / 4.79 / 10.88
|77.6K ops/s
|6.30 / 17.55 / 39.38 (cache OFF)
|20.4K ops/s (21.9K with cache)
|-
|-

|200
|3.18 / 9.43 / 19.27
|50.2K ops/s
|9.95 / 31.25 / 72.38
|17.1K ops/s
|81.8%
|200

|250
|4.09 / 12.11 / 23.92
|48.8K ops/s
|12.89 / 43.35 / 103.6
|16.3K ops/s
|96.7%
|225

|300 (Max)
|5.29 / 15.0 / 31.32
|45.9K ops/s
|15.48 / 46.28 / 100.81
|16.6K ops/s
|80.9%
|223
|===

**Key Findings:**

* **50 connections** is the sweet spot for CI/CD - excellent performance across all metrics
* **100 connections** marks JWT degradation beginning
* **150 connections** provides good stress testing balance (77.6K ops/s health, 20.4-21.9K ops/s JWT)
* **200+ connections** causes degradation
* **Health checks** scale excellently to high connection counts
* **Cache effectiveness** verified at 150 connections: +7.4% throughput with size 20

=== Bottleneck Identification

**Root Cause: Docker Bridge Networking** ðŸŽ¯

Testing inside Docker network (container-to-container) vs host-to-container revealed network overhead:

* **Container-to-container** (50 conns, health): 0.91ms avg latency, 74.3K ops/s
* **Host-to-container** (50 conns, health): 1.0ms P50 / 2.48ms P90, 37.6K ops/s (standard test setup)
* **Improvement**: ~2x throughput when bypassing Docker bridge (host network stack)
* **Conclusion**: Application is performant. Docker bridge adds overhead. Production Kubernetes pod-to-pod networking performs better.

**Secondary Bottlenecks (Application-Level):**

1. **JWT processing overhead** (55,700 ops/s gap from health check with cache enabled)
2. **Token cache effectiveness** - Cache size of 20 achieved 100% hit rate (239,156/239,156 validations), providing 7.4% throughput improvement
3. **Average validation time** - 0.33ms per cached token (vs ~6ms for full validation)
4. **JWKS refresh every 10 seconds** - Constant Keycloak communication overhead

=== Performance Ceiling

* **Health check capacity**: 77,600 ops/s (excellent scaling)
* **JWT validation capacity (cache OFF)**: 20,400 ops/s (strong performance)
* **JWT validation capacity (cache ON)**: 21,900 ops/s (+7.4% improvement)
* **Performance gap**: 55,700 ops/s between health and JWT endpoints (cache ON)

== Conclusion

WRK stress testing with 150 connections reveals:

* **Health endpoint**: 77,600 ops/s with 1.53ms P50 / 4.79ms P90 latency
* **JWT endpoint (cache OFF)**: 20,400 ops/s with 6.30ms P50 / 17.55ms P90 latency
* **JWT endpoint (cache ON, size 20)**: 21,900 ops/s with 5.88ms P50 / 16.16ms P90 latency (+7.4% throughput)
* **Test profiles**: 50 connections (default), 150 connections (stress), 300 connections (max load)
* **Primary bottleneck**: JWT cryptographic validation overhead
* **Cache effectiveness**: Lock-free cache delivers 7.4% throughput improvement without performance collapse