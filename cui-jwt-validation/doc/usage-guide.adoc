= JWT Validation Usage Guide
:toc: left
:toclevels: 3
:source-highlighter: highlight.js

This guide provides practical examples and patterns for using the JWT validation library.

== Basic Token Validation

The simplest way to validate a JWT token:

[source,java]
----
// Create TokenValidator
TokenValidator tokenValidator = TokenValidator.builder()
    .issuerConfig(IssuerConfig.builder()
        .issuer("https://example.com")
        .signatureKey("your-secret-key")
        .build())
    .build();

// Validate and create token (throws TokenValidationException if invalid)
try {
    AccessTokenContent token = tokenValidator.createAccessToken(jwtString);
    String subject = token.getSubject();
    List<String> roles = token.getRoles();
} catch (TokenValidationException e) {
    // Handle validation failure
    LOGGER.error("Token validation failed: {}", e.getMessage(), e);
}
----

== Access Token Caching

The library provides built-in caching for validated access tokens:

[source,java]
----
// Enable caching with configuration
AccessTokenCacheConfig cacheConfig = AccessTokenCacheConfig.builder()
    .maxSize(1000)
    .ttlSeconds(300)
    .build();

TokenValidator tokenValidator = TokenValidator.builder()
    .accessTokenCacheConfig(cacheConfig)
    .issuerConfig(issuerConfig)
    .build();

// Subsequent validations of the same token are cached
AccessTokenContent token1 = tokenValidator.createAccessToken(jwtString);
AccessTokenContent token2 = tokenValidator.createAccessToken(jwtString); // From cache
----

== Multi-Issuer Configuration

Configure multiple identity providers:

[source,java]
----
TokenValidator tokenValidator = TokenValidator.builder()
    .issuerConfig(IssuerConfig.builder()
        .issuer("https://keycloak.example.com/auth/realms/main")
        .jwksUri("https://keycloak.example.com/auth/realms/main/protocol/openid-connect/certs")
        .build())
    .issuerConfig(IssuerConfig.builder()
        .issuer("https://auth0.example.com/")
        .jwksUri("https://auth0.example.com/.well-known/jwks.json")
        .build())
    .build();

// Validator automatically selects correct issuer based on token
AccessTokenContent token = tokenValidator.createAccessToken(jwtString);
----

== OpenID Connect Discovery

Automatic configuration using OpenID Connect discovery:

[source,java]
----
// Create well-known configuration
String issuerUrl = "https://accounts.google.com";
URL wellKnownUrl = new URL(issuerUrl + "/.well-known/openid-configuration");

WellKnownConfig wellKnownConfig = WellKnownConfig.builder()
    .wellKnownUrl(wellKnownUrl.toString())
    .build();

// Create resolver and configure JWKS loader
HttpWellKnownResolver resolver = new HttpWellKnownResolver(wellKnownConfig);

HttpJwksLoaderConfig jwksConfig = HttpJwksLoaderConfig.builder()
    .wellKnown(resolver)
    .build();

// Build issuer config from discovery
IssuerConfig issuerConfig = IssuerConfig.builder()
    .expectedAudience("your-client-id")
    .httpJwksLoaderConfig(jwksConfig)
    .build();
----

=== Using HttpWellKnownResolver

[source,java]
----
String issuerUrl = "https://example.com";
URL wellKnownUrl = new URL(issuerUrl + "/.well-known/openid-configuration");

WellKnownConfig wellKnownConfig = WellKnownConfig.builder()
    .wellKnownUrl(wellKnownUrl.toString())
    .build();

HttpWellKnownResolver resolver = new HttpWellKnownResolver(wellKnownConfig);

// Use resolver with HttpJwksLoaderConfig
HttpJwksLoaderConfig jwksConfig = HttpJwksLoaderConfig.builder()
    .wellKnown(resolver)
    .build();

IssuerConfig issuerConfig = IssuerConfig.builder()
    .expectedAudience("your-client-id")
    .httpJwksLoaderConfig(jwksConfig)
    .build();
----

=== Configuring HttpJwksLoaderConfig

[source,java]
----
HttpJwksLoaderConfig loaderConfig = HttpJwksLoaderConfig.builder()
    .connectTimeoutMs(5000)
    .readTimeoutMs(5000)
    .maxRetries(3)
    .retryDelayMs(1000)
    .build();

IssuerConfig issuerConfig = IssuerConfig.builder()
    .issuer("https://example.com")
    .jwksUri("https://example.com/.well-known/jwks.json")
    .jwksLoaderConfig(loaderConfig)
    .build();
----

=== Configuring TokenValidator

[source,java]
----
TokenValidator tokenValidator = TokenValidator.builder()
    .issuerConfig(issuerConfig)
    .parserConfig(ParserConfig.builder()
        .maxTokenSize(16384)
        .maxPayloadSize(8192)
        .build())
    .clockSkew(Duration.ofSeconds(30))
    .build();
----

== Custom Claim Mapping

Map custom claims to roles and groups:

[source,java]
----
// Configure custom claim paths
RolesGroupsConfig rolesConfig = RolesGroupsConfig.builder()
    .rolesPath("realm_access/roles")
    .groupsPath("groups")
    .build();

IssuerConfig issuerConfig = IssuerConfig.builder()
    .issuer("https://example.com")
    .rolesGroupsConfig(rolesConfig)
    .build();

TokenValidator validator = TokenValidator.builder()
    .issuerConfig(issuerConfig)
    .build();

// Token claims are automatically mapped
AccessTokenContent token = validator.createAccessToken(jwtString);
Set<String> roles = token.getRoles(); // From realm_access/roles
Set<String> groups = token.getGroups(); // From groups claim
----

For more examples, see the xref:api-reference.adoc[API Reference].